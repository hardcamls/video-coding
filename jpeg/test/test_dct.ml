(* Test forward and inverse DCTs. *)
open Core
open Hardcaml
open Hardcaml_waveterm
module Dct = Hardcaml_jpeg.Dct.Simple

let expected inputs =
  let x =
    Test_dct_fixed.eval_in_fixed_point
      ~fixed_prec:12
      ~coefs:Hardcaml_jpeg_model.Dct.Reference.Eight_point.forward_transform_matrix.(0)
      ~inputs
  in
  print_s [%message (x : int * float)]
;;

let%expect_test "test loops" =
  let module Sim = Cyclesim.With_interface (Dct.I) (Dct.O) in
  let scope = Scope.create ~flatten_design:true () in
  let sim = Sim.create ~config:Cyclesim.Config.trace_all (Dct.create scope) in
  let waves, sim = Waveform.create sim in
  let inputs = Cyclesim.inputs sim in
  let fdct_inputs =
    Array.init 8 ~f:(fun _ -> Array.init 8 ~f:(fun _ -> Random.int 400 - 200))
  in
  expected fdct_inputs.(0);
  [%expect {| (x (-383720 -93.681640625)) |}];
  let outputs = Cyclesim.outputs sim in
  let cycle () =
    let coef_address = outputs.coef_address in
    Cyclesim.cycle sim;
    let row, col =
      Bits.(to_int !coef_address.:[5, 4]), Bits.(to_int !coef_address.:[2, 1])
    in
    inputs.coef := Bits.of_int ~width:12 fdct_inputs.(row).(col)
  in
  inputs.start := Bits.vdd;
  cycle ();
  inputs.start := Bits.gnd;
  for _ = 0 to 200 do
    cycle ()
  done;
  Waveform.print ~display_width:120 ~display_height:50 ~wave_width:1 ~start_cycle:0 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
    │clear             ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬─────│
    │coef              ││ 000│FE6    │084    │F7C    │05A    │FE6    │084    │F7C    │05A    │FE6    │084    │F7C    │05A  │
    │                  ││────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴─────│
    │start             ││────┐                                                                                             │
    │                  ││    └─────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─│
    │coef_address      ││ 00     │01 │02 │03 │04 │05 │06 │07 │00 │01 │02 │03 │04 │05 │06 │07 │00 │01 │02 │03 │04 │05 │06 │0│
    │                  ││────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─│
    │coef_read         ││    ┌─────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────┘                                                                                             │
    │                  ││────────────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─│
    │pixel             ││ 00             │F7 │EA │27 │5C │2F │09 │1A │23 │1B │0F │28 │1B │4A │FF │61 │48 │3F │39 │20 │DF │0│
    │                  ││────────────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │pixel_address     ││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │pixel_write       ││                                            ┌───┐                           ┌───┐                 │
    │                  ││────────────────────────────────────────────┘   └───────────────────────────┘   └─────────────────│
    │STATE             ││    ┌─────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────┘                                                                                             │
    │pass              ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │vdd               ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │x                 ││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────┬───────────────────────────────┬─────────────────────────────│
    │y                 ││ 0                                  │1                              │2                            │
    │                  ││────────────────────────────────────┴───────────────────────────────┴─────────────────────────────│
    │                  ││────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─│
    │z                 ││ 0      │1  │2  │3  │4  │5  │6  │7  │0  │1  │2  │3  │4  │5  │6  │7  │0  │1  │2  │3  │4  │5  │6  │7│
    │                  ││────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─│
    │                  ││                                                                                                  │
    │                  ││                                                                                                  │
    │                  ││                                                                                                  │
    │                  ││                                                                                                  │
    │                  ││                                                                                                  │
    │                  ││                                                                                                  │
    │                  ││                                                                                                  │
    │                  ││                                                                                                  │
    │                  ││                                                                                                  │
    │                  ││                                                                                                  │
    │                  ││                                                                                                  │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]
;;
