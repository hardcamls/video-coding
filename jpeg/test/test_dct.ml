(* Test forward and inverse DCTs. *)
open Core
open Hardcaml
open Hardcaml_waveterm

module Make (Config : sig
  include Hardcaml_jpeg.Dct.Config

  val test_range : int
end) =
struct
  module Dct = Hardcaml_jpeg.Dct.Make (Config)

  let display_rules =
    let module I = Display_rules.With_interface (Dct.I) in
    let module O = Display_rules.With_interface (Dct.O) in
    List.concat
      [ I.default ~wave_format:Int ()
      ; O.default ~wave_format:Int ()
      ; Display_rule.
          [ port_name_is "dct_coef" ~wave_format:Int
          ; port_name_is "dct_mul" ~wave_format:Int
          ; port_name_is "dct_mac" ~wave_format:Int
          ; port_name_is "x" ~wave_format:Unsigned_int
          ; port_name_is "y" ~wave_format:Unsigned_int
          ; port_name_is "z" ~wave_format:Unsigned_int
          ; port_name_is "pass" ~wave_format:Bit
          ]
      ]
  ;;

  let create_inputs () =
    let inputs =
      Array.init 8 ~f:(fun _ ->
          Array.init 8 ~f:(fun _ ->
              Random.int (Config.test_range * 2) - Config.test_range))
    in
    inputs
  ;;

  let simulate_dct ?(waves = true) ?(verbose = false) dct_inputs =
    let module Sim = Cyclesim.With_interface (Dct.I) (Dct.O) in
    let scope = Scope.create ~flatten_design:true () in
    let sim = Sim.create ~config:Cyclesim.Config.trace_all (Dct.create scope) in
    let waves, sim =
      if waves
      then (
        let waves, sim = Waveform.create sim in
        Some waves, sim)
      else None, sim
    in
    let inputs = Cyclesim.inputs sim in
    let outputs = Cyclesim.outputs sim in
    let transpose = Array.init 8 ~f:(fun _ -> Array.init 8 ~f:(fun _ -> 0)) in
    let pixels = Array.init 8 ~f:(fun _ -> Array.init 8 ~f:(fun _ -> 0)) in
    let cycle () =
      let waddr = !(outputs.write_address) in
      (if Bits.to_bool !(outputs.transpose_write)
      then
        Bits.(
          transpose.(Bits.to_int waddr.:[5, 3]).(Bits.to_int waddr.:[2, 0])
            <- Bits.to_sint !(outputs.transpose_coef_out)));
      (if Bits.to_bool !(outputs.pixel_write)
      then
        Bits.(
          pixels.(Bits.to_int waddr.:[5, 3]).(Bits.to_int waddr.:[2, 0])
            <- Bits.to_sint !(outputs.pixel)));
      let raddr = !(outputs.read_address) in
      let renc = !(outputs.coef_read) in
      let rent = !(outputs.transpose_read) in
      Cyclesim.cycle sim;
      let row, col = Bits.(to_int raddr.:[5, 3]), Bits.(to_int raddr.:[2, 0]) in
      if Bits.to_bool renc
      then inputs.coef := Bits.of_int ~width:Config.input_bits dct_inputs.(row).(col);
      if Bits.to_bool rent
      then
        inputs.transpose_coef_in
          := Bits.of_int ~width:Dct.transpose_bits transpose.(row).(col)
    in
    inputs.start := Bits.vdd;
    cycle ();
    inputs.start := Bits.gnd;
    for _ = 0 to 1200 do
      cycle ()
    done;
    if verbose
    then
      print_s
        [%message
          (dct_inputs : int array array)
            (transpose : int array array)
            (pixels : int array array)];
    waves, transpose, pixels
  ;;

  let simulate_dct_waveform ?verbose dct_inputs =
    let waves, _, _ = simulate_dct ~waves:true ?verbose dct_inputs in
    Option.value_exn waves
  ;;

  let simulate_dct dct_inputs =
    let _, transpose, results = simulate_dct ~waves:false dct_inputs in
    transpose, results
  ;;

  let reference dct_inputs =
    let open Hardcaml_jpeg_model.Dct in
    let coefs = Fixed_point.fixed_coefs Config.transform_matrix ~fixed_prec:12 in
    let transpose =
      Matrix8x8.imul coefs dct_inputs
      |> Fixed_point.round_matrix ~prec:(Config.rom_prec - Config.transpose_prec)
    in
    let unscaled_result = Matrix8x8.imul transpose (Matrix8x8.transpose coefs) in
    let result =
      Fixed_point.round_matrix
        unscaled_result
        ~prec:(Config.rom_prec + Config.transpose_prec)
    in
    let output_max = 1 lsl (Config.output_bits - 1) in
    let result = Matrix8x8.iclip ~min:(-output_max) ~max:(output_max - 1) result in
    transpose, result
  ;;

  let print_reference dct_inputs =
    let open Hardcaml_jpeg_model.Dct in
    let transpose, result = reference dct_inputs in
    print_s [%message (transpose : int Matrix8x8.t) (result : int Matrix8x8.t)]
  ;;
end

module Dct = struct
  module Dct = Make (struct
    include Hardcaml_jpeg.Dct.Dct_config

    let test_range = 128
  end)

  open Dct

  let%expect_test "test idct" =
    let dct_inputs = create_inputs () in
    print_reference dct_inputs;
    [%expect
      {|
      ((transpose
        ((854 -1086 -950 -23 -17 549 486 -1346)
         (2981 -2377 -40 -1959 1498 -287 -207 312)
         (-1213 1529 -1217 838 -42 -685 -449 274)
         (-273 -1917 -369 1136 -1391 898 -869 279)
         (-368 -1029 1346 532 -469 1058 1810 -181)
         (-238 935 -92 1920 -1840 812 871 -634)
         (692 971 -11 339 121 2531 -1320 -1142)
         (-352 2205 1788 -1363 1255 -595 -360 770)))
       (result
        ((-34 1 -15 113 10 77 0 2) (-2 9 81 135 127 25 110 166)
         (-21 2 -14 -50 15 -67 -107 -84) (-55 -51 -32 -13 44 80 99 -96)
         (60 -68 -37 -14 -81 112 40 25) (38 21 -14 -28 -73 97 -43 -137)
         (48 73 -61 108 -48 -48 72 -101) (74 58 23 -72 -60 -152 -13 91)))) |}];
    let waves = simulate_dct_waveform ~verbose:true dct_inputs in
    Waveform.print
      ~display_width:190
      ~display_height:60
      ~wave_width:4
      ~start_cycle:(8 * 0)
      ~display_rules
      waves;
    [%expect
      {|
      ((dct_inputs
        ((62 -84 -28 34 -25 71 6 -29) (85 -128 -92 -105 88 -120 -17 23)
         (111 89 20 -105 104 27 -43 -49) (65 -127 -7 43 -64 47 127 -71)
         (10 -78 95 -77 42 3 32 15) (12 -72 -93 80 -76 113 -81 -75)
         (-100 106 -38 81 -76 -65 24 -2) (-94 102 -25 45 4 21 38 -50)))
       (transpose
        ((854 -1086 -950 -23 -17 549 486 -1346)
         (2981 -2377 -40 -1959 1498 -287 -207 312)
         (-1213 1529 -1217 838 -42 -685 -449 274)
         (-273 -1917 -369 1136 -1391 898 -869 279)
         (-368 -1029 1346 532 -469 1058 1810 -181)
         (-238 935 -92 1920 -1840 812 871 -634)
         (692 971 -11 339 121 2531 -1320 -1142)
         (-352 2205 1788 -1363 1255 -595 -360 770)))
       (pixels
        ((-34 1 -15 113 10 77 0 2) (-2 9 81 135 127 25 110 166)
         (-21 2 -14 -50 15 -67 -107 -84) (-55 -51 -32 -13 44 80 99 -96)
         (60 -68 -37 -14 -81 112 40 25) (38 21 -14 -28 -73 97 -43 -137)
         (48 73 -61 108 -48 -48 72 -101) (74 58 23 -72 -60 -152 -13 91))))
      ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
      │clock             ││┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐  │
      │                  ││     └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └──│
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      │clear             ││ 0                                                                                                                                                                      │
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      │                  ││──────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      │start             ││ -1       │0                                                                                                                                                            │
      │                  ││──────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      │                  ││────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬───────│
      │coef              ││ 0                  │62       │85       │111      │65       │10       │12       │-100     │-94      │-84      │-128     │89       │-127     │-78      │-72      │106    │
      │                  ││────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴───────│
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      │transpose_coef_in ││ 0                                                                                                                                                                      │
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      │                  ││────────────────────────────────────────┬─────────┬─────────┬─────────┬───────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬───────│
      │pixel             ││ 0                                      │1        │3        │6        │7                  │8        │5        │3        │-2       │-5       │-3       │-6       │-7     │
      │                  ││────────────────────────────────────────┴─────────┴─────────┴─────────┴───────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴───────│
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      │pixel_write       ││ 0                                                                                                                                                                      │
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      │                  ││────────────────────────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬───────│
      │transpose_coef_out││ 0                                      │351      │831      │1459     │1827     │1884     │1951     │1386     │854      │-475     │-1199    │-696     │-1414    │-1855  │
      │                  ││────────────────────────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴───────│
      │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────┬─────────┬───────────────────────────────────────────────│
      │transpose_write   ││ 0                                                                                                            │-1       │0                                              │
      │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────┴─────────┴───────────────────────────────────────────────│
      │                  ││──────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      │coef_read         ││ 0        │-1                                                                                                                                                           │
      │                  ││──────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      │transpose_read    ││ 0                                                                                                                                                                      │
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      │                  ││────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬───────│
      │read_address      ││ 0                  │8        │16       │24       │-32      │-24      │-16      │-8       │1        │9        │17       │25       │-31      │-23      │-15      │-7     │
      │                  ││────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴───────│
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬───────────────────────────────────────────────│
      │write_address     ││ 0                                                                                                                      │1                                              │
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────│
      │                  ││──────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      │dct_coef          ││ 0        │1448                                                                                                                                                         │
      │                  ││──────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      │                  ││──────────────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬───────│
      │dct_mul           ││ 0                            │89776    │123080   │160728   │94120    │14480    │17376    │-144800  │-136112  │-121632  │-185344  │128872   │-183896  │-112944  │-104256│
      │                  ││──────────────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴───────│
      │                  ││────────────────────────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬───────│
      │dct_mac           ││ 0                                      │89776    │212856   │373584   │467704   │482184   │499560   │354760   │218648   │-121632  │-306976  │-178104  │-362000  │-474944│
      │                  ││────────────────────────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴───────│
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      │x                 ││ 0                                                                                                                                                                      │
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      │                  ││──────────────────────────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────────────│
      │y                 ││ 0                                                                                        │1                                                                            │
      │                  ││──────────────────────────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────────────│
      │                  ││────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬───────│
      │z                 ││ 0                  │1        │2        │3        │4        │5        │6        │7        │0        │1        │2        │3        │4        │5        │6        │7      │
      │                  ││────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴───────│
      │pass              ││                                                                                                                                                                        │
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
      └──────────────────┘└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]
  ;;
end

module Idct = struct
  module Idct = Make (struct
    include Hardcaml_jpeg.Dct.Idct_config

    let test_range = 200
  end)

  open Idct

  let%expect_test "test idct" =
    let idct_inputs = create_inputs () in
    print_reference idct_inputs;
    [%expect
      {|
    ((transpose
      ((-1976 852 -1195 -152 -587 -2373 -2576 -785)
       (61 2948 -232 416 275 1295 -2616 -3121)
       (-752 2377 86 -12 -2946 1026 409 -424)
       (1437 -2720 -4098 -1455 -284 -1025 3033 -548)
       (1199 832 -1374 -1232 3817 2221 -2883 -2801)
       (-658 1237 -787 3463 -304 793 -290 -2428)
       (-1456 180 2132 817 -1075 596 -1350 -815)
       (969 267 -505 2228 334 317 -1782 2007)))
     (result
      ((-128 127 -106 -21 38 -75 -80 -98) (74 127 -112 127 -95 -43 -21 -128)
       (13 75 96 -35 -128 22 0 -128) (-128 -119 127 106 109 127 -78 86)
       (52 19 -128 127 15 -118 -1 22) (79 20 -128 47 -38 127 -38 -128)
       (22 52 -112 -74 -128 -33 60 -43) (77 8 -41 -26 127 -22 111 -91)))) |}];
    let waves = simulate_dct_waveform ~verbose:true idct_inputs in
    Waveform.print
      ~display_width:190
      ~display_height:60
      ~wave_width:4
      ~start_cycle:(8 * 64)
      ~display_rules
      waves;
    [%expect
      {|
    ((dct_inputs
      ((-26 132 -132 90 -17 63 -178 -197) (-51 88 -84 -145 -64 -80 -9 -97)
       (-105 81 140 111 -80 -93 -179 119) (-87 25 17 51 120 -25 -137 -159)
       (98 -166 -185 -117 162 -101 -8 103) (-92 -160 -5 -56 -180 -151 183 93)
       (-44 50 -30 121 -116 -41 64 86) (-54 94 143 -91 28 77 -146 6)))
     (transpose
      ((-1976 852 -1195 -152 -587 -2373 -2576 -785)
       (61 2948 -232 416 275 1295 -2616 -3121)
       (-752 2377 86 -12 -2946 1026 409 -424)
       (1437 -2720 -4098 -1455 -284 -1025 3033 -548)
       (1199 832 -1374 -1232 3817 2221 -2883 -2801)
       (-658 1237 -787 3463 -304 793 -290 -2428)
       (-1456 180 2132 817 -1075 596 -1350 -815)
       (969 267 -505 2228 334 317 -1782 2007)))
     (pixels
      ((-128 127 -106 -21 38 -75 -80 -98) (74 127 -112 127 -95 -43 -21 -128)
       (13 75 96 -35 -128 22 0 -128) (-128 -119 127 106 109 127 -78 86)
       (52 19 -128 127 15 -118 -1 22) (79 20 -128 47 -38 127 -38 -128)
       (22 52 -112 -74 -128 -33 60 -43) (77 8 -41 -26 127 -22 111 -91))))
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐    ┌────┐  │
    │                  ││     └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └────┘    └──│
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │clear             ││ 0                                                                                                                                                                      │
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │start             ││ 0                                                                                                                                                                      │
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │coef              ││ 86       │6                                                                                                                                                            │
    │                  ││──────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬───────│
    │transpose_coef_in ││ 0                  │-1976    │852      │-1195    │-152     │-587     │-2373    │-2576    │-785     │-1976    │852      │-1195    │-152     │-587     │-2373    │-2576  │
    │                  ││────────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴───────│
    │                  ││──────────┬─────────┬───────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬───────────────────┬─────────┬─────────┬─────────┬─────────┬───────│
    │pixel             ││ 8        │7        │8                  │-44      │-18      │-52      │-56      │-69      │-110     │-128               │-44      │-22      │-36      │-35      │-22    │
    │                  ││──────────┴─────────┴───────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴───────────────────┴─────────┴─────────┴─────────┴─────────┴───────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────┬─────────┬───────────────────────────────────────────────│
    │pixel_write       ││ 0                                                                                                            │-1       │0                                              │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────┴─────────┴───────────────────────────────────────────────│
    │                  ││──────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬───────│
    │transpose_coef_out││ 2167     │1753     │2017     │2007     │-11177   │-4491    │-13322   │-14334   │-17654   │-28202   │-36091   │-37318   │-11177   │-5509    │-9169    │-8931    │-5611  │
    │                  ││──────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴───────│
    │                  ││──────────────────────────────┬─────────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │transpose_write   ││ 0                            │-1       │0                                                                                                                              │
    │                  ││──────────────────────────────┴─────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │coef_read         ││ -1       │0                                                                                                                                                            │
    │                  ││──────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │transpose_read    ││ 0        │-1                                                                                                                                                           │
    │                  ││──────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬───────│
    │read_address      ││ -1       │0        │1        │2        │3        │4        │5        │6        │7        │0        │1        │2        │3        │4        │5        │6        │7      │
    │                  ││──────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴───────│
    │                  ││────────────────────────────────────────┬───────────────────────────────────────────────────────────────────────────────┬───────────────────────────────────────────────│
    │write_address     ││ -1                                     │0                                                                              │1                                              │
    │                  ││────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────│
    │                  ││──────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬───────│
    │dct_coef          ││ 784      │-400     │1448     │2009     │1892     │1703     │1448     │1138     │784      │400      │1448     │1703     │784      │-400     │-1448    │-2009    │-1892  │
    │                  ││──────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴───────│
    │                  ││──────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬───────│
    │dct_mul           ││ -105834  │67424    │-2400    │-2861248 │1711668  │-2260940 │-258856  │-849976  │-2700474 │-2019584 │-314000  │-2861248 │1450956  │-936880  │60800    │849976   │4767357│
    │                  ││──────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴───────│
    │                  ││──────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬───────│
    │dct_mac           ││ 554686   │448852   │516276   │513876   │-2861248 │-1149580 │-3410520 │-3669376 │-4519352 │-7219826 │-9239410 │-9553410 │-2861248 │-1410292 │-2347172 │-2286372 │-143639│
    │                  ││──────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴───────│
    │                  ││──────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │x                 ││ 7        │0                                                                                                                                                            │
    │                  ││──────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────┬───────────────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────────────│
    │y                 ││ 7        │0                                                                              │1                                                                            │
    │                  ││──────────┴───────────────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬───────│
    │z                 ││ 7        │0        │1        │2        │3        │4        │5        │6        │7        │0        │1        │2        │3        │4        │5        │6        │7      │
    │                  ││──────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┴───────│
    │pass              ││          ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────┘                                                                                                                                                             │
    └──────────────────┘└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]
  ;;
end
