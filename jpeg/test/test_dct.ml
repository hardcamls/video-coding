(* Test forward and inverse DCTs. *)
open Core
open Hardcaml
open Hardcaml_waveterm
module Dct = Hardcaml_jpeg.Dct

(* 
  fdct
    - input 8 bits 
    - rom 12 bits
    - (12+8+3)=23 bit mac
    - 4 bit transpose fixed point -> (8+3+4)=15 bits
  - 2nd stage
    - input 15 bits 
    - rom 12 bits 
    - (12+15+3)=30 bits mac -> fixed point @ (12+4)=16 bits
    - output clipped to 12 bits

  idct
    - input 12 bits
    - rom 16 bits
    - (16+12+3)=31 bits
    - 4 bit transpose fixed point -> (31-16+4)=19 bits
  - 2nd stage 
    - input 19 bits 
    - rom 16 bits
    - (19+16+3)=38 bits mac -> fixed point @ (16+4)=20 bits
    - output clipped to 8 bits
*)

let expected inputs ~row =
  let v =
    Test_dct_fixed.eval_in_fixed_point
      ~fixed_prec:12
      ~coefs:Hardcaml_jpeg_model.Dct.Reference.Eight_point.inverse_transform_matrix.(row)
      ~inputs
  in
  v
;;

let%expect_test "inverse matrix, scaled" =
  let m = Hardcaml_jpeg_model.Dct.Reference.Eight_point.inverse_transform_matrix in
  let m =
    Array.map
      m
      ~f:(Array.map ~f:(fun f -> Float.(f * (2. ** of_int 12) |> round_nearest)))
  in
  print_s [%message (m : float array array)];
  [%expect
    {|
    (m
     ((1448 2009 1892 1703 1448 1138 784 400)
      (1448 1703 784 -400 -1448 -2009 -1892 -1138)
      (1448 1138 -784 -2009 -1448 400 1892 1703)
      (1448 400 -1892 -1138 1448 1703 -784 -2009)
      (1448 -400 -1892 1138 1448 -1703 -784 2009)
      (1448 -1138 -784 2009 -1448 -400 1892 -1703)
      (1448 -1703 784 400 -1448 2009 -1892 1138)
      (1448 -2009 1892 -1703 1448 -1138 784 -400))) |}]
;;

let display_rules =
  let module I = Display_rules.With_interface (Dct.I) in
  let module O = Display_rules.With_interface (Dct.O) in
  List.concat
    [ I.default ()
    ; O.default ()
    ; Display_rule.
        [ port_name_is "dct_coef" ~wave_format:Int
        ; port_name_is "dct_mul" ~wave_format:Int
        ; port_name_is "dct_mac" ~wave_format:Int
        ; port_name_is "x" ~wave_format:Unsigned_int
        ; port_name_is "y" ~wave_format:Unsigned_int
        ; port_name_is "z" ~wave_format:Unsigned_int
        ]
    ]
;;

let create_inputs () =
  let inputs =
    Array.init 8 ~f:(fun _ -> Array.init 8 ~f:(fun _ -> Random.int 400 - 200))
  in
  inputs
;;

let simulate_idct idct_inputs =
  let module Sim = Cyclesim.With_interface (Dct.I) (Dct.O) in
  let scope = Scope.create ~flatten_design:true () in
  let sim = Sim.create ~config:Cyclesim.Config.trace_all (Dct.create scope) in
  let waves, sim = Waveform.create sim in
  let inputs = Cyclesim.inputs sim in
  let outputs = Cyclesim.outputs sim in
  let transpose = Array.init 8 ~f:(fun _ -> Array.init 8 ~f:(fun _ -> 0)) in
  let pixels = Array.init 8 ~f:(fun _ -> Array.init 8 ~f:(fun _ -> 0)) in
  let cycle () =
    if Bits.to_bool !(outputs.transpose_write)
    then (
      let addr = !(outputs.write_address) in
      Bits.(
        transpose.(Bits.to_int addr.:[5, 3]).(Bits.to_int addr.:[2, 0])
          <- Bits.to_sint !(outputs.transpose_coef_out)));
    if Bits.to_bool !(outputs.pixel_write)
    then (
      let addr = !(outputs.write_address) in
      Bits.(
        pixels.(Bits.to_int addr.:[5, 3]).(Bits.to_int addr.:[2, 0])
          <- Bits.to_sint !(outputs.pixel)));
    Cyclesim.cycle sim;
    let row, col =
      let addr = !(outputs.read_address) in
      Bits.(to_int addr.:[5, 3]), Bits.(to_int addr.:[2, 0])
    in
    inputs.coef := Bits.of_int ~width:Dct.input_bits idct_inputs.(row).(col);
    inputs.transpose_coef_in
      := Bits.of_int ~width:Dct.transpose_bits transpose.(row).(col)
  in
  inputs.start := Bits.vdd;
  cycle ();
  inputs.start := Bits.gnd;
  for _ = 0 to 1200 do
    cycle ()
  done;
  print_s
    [%message
      (idct_inputs : int array array)
        (transpose : int array array)
        (pixels : int array array)];
  waves
;;

let%expect_test "test idct" =
  let idct_inputs = create_inputs () in
  let expected =
    Array.init 8 ~f:(fun r ->
        Array.init 8 ~f:(fun c -> (expected idct_inputs.(r) ~row:c).scaled_and_clipped))
  in
  print_s [%message (expected : int array array)];
  [%expect
    {|
    (expected
     ((-10 124 -128 127 -31 23 -16 -128) (-128 110 64 63 -63 -31 -124 -32)
      (37 127 -110 -128 24 -127 65 -107) (4 55 -128 86 -26 -53 -68 -18)
      (-128 -91 53 103 127 -35 -18 127) (-128 -67 124 -128 -20 110 -42 71)
      (14 -5 47 -128 33 74 -15 -128) (59 74 -43 16 -111 -128 57 -1))) |}];
  let waves = simulate_idct idct_inputs in
  Waveform.print
    ~display_width:190
    ~display_height:60
    ~wave_width:2
    ~start_cycle:(8 * 0)
    ~display_rules
    waves;
  [%expect
    {|
    ((idct_inputs
      ((-26 132 -132 90 -17 63 -178 -197) (-51 88 -84 -145 -64 -80 -9 -97)
       (-105 81 140 111 -80 -93 -179 119) (-87 25 17 51 120 -25 -137 -159)
       (98 -166 -185 -117 162 -101 -8 103) (-92 -160 -5 -56 -180 -151 183 93)
       (-44 50 -30 121 -116 -41 64 86) (-54 94 143 -91 28 77 -146 6)))
     (transpose
      ((0 0 0 0 0 0 0 0) (0 0 0 0 0 0 0 0) (0 0 0 0 0 0 0 0) (0 0 0 0 0 0 0 0)
       (0 0 0 0 0 0 0 0) (0 0 0 0 0 0 0 0) (0 0 0 0 0 0 0 0)
       (747 22421 509 23072 356 22161 22054 0)))
     (pixels
      ((0 0 0 0 0 0 0 0) (0 0 0 0 0 0 0 0) (0 0 0 0 0 0 0 0) (0 0 0 0 0 0 0 0)
       (0 0 0 0 0 0 0 0) (0 0 0 0 0 0 0 0) (0 0 0 0 0 0 0 0)
       (0 0 0 0 0 0 0 -128))))
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  │
    │                  ││   └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──│
    │clear             ││                                                                                                                                                                        │
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │start             ││──────┐                                                                                                                                                                 │
    │                  ││      └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────│
    │coef              ││ 000  │FE6  │FCD  │F97  │FA9  │062  │FA4  │FD4  │FCA  │FE6  │FCD  │F97  │FA9  │062  │FA4  │FD4  │FCA  │FE6  │FCD  │F97  │FA9  │062  │FA4  │FD4  │FCA  │FE6  │FCD  │F97  │
    │                  ││──────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────│
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────┬─────┬─────────────────────────────────────────┬─────┬─────────────────│
    │transpose_coef_in ││ 00000                                                                                          │059ED│00000                                    │059ED│00000            │
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────┴─────┴─────────────────────────────────────────┴─────┴─────────────────│
    │                  ││────────────────────────┬───────────────────────────────────────────────────────────────────────────────────┬───────────┬─────────────────┬───────────┬─────────────────│
    │pixel             ││ 00                     │7F                                                                                 │80         │7F               │80         │7F               │
    │                  ││────────────────────────┴───────────────────────────────────────────────────────────────────────────────────┴───────────┴─────────────────┴───────────┴─────────────────│
    │pixel_write       ││                                                                                                                                                                        │
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────│
    │transpose_coef_out││ 00000            │059ED│0D5ED│14925│1B152│1B37C│1F903│2297D│24228│059ED│0C30A│0F2C8│0DA50│0D826│05D68│7E86D│7A23D│059ED│0A02A│0706C│7F587│7F35C│00BCC│080C7│0E9D0│059ED│
    │                  ││──────────────────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────│
    │transpose_write   ││                                                                  ┌─────┐                                         ┌─────┐                                         ┌─────│
    │                  ││──────────────────────────────────────────────────────────────────┘     └─────────────────────────────────────────┘     └─────────────────────────────────────────┘     │
    │coef_read         ││      ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────┘                                                                                                                                                                 │
    │transpose_read    ││                                                                                                                                                                        │
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────│
    │read_address      ││ 00         │08   │10   │18   │20   │28   │30   │38   │00   │08   │10   │18   │20   │28   │30   │38   │00   │08   │10   │18   │20   │28   │30   │38   │00   │08   │10   │
    │                  ││────────────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────│
    │                  ││──────────────────────────────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────│
    │write_address     ││ 00                           │08   │10   │18   │20   │28   │30   │38   │00   │08   │10   │18   │20   │28   │30   │38   │00   │08   │10   │18   │20   │28   │30   │38   │
    │                  ││──────────────────────────────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────│
    │                  ││────────────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────│
    │dct_coef          ││ 1448       │2009 │1892 │1703 │1448 │1138 │784  │400  │1448 │1703 │784  │-400 │-1448│-2009│-1892│-1138│1448 │1138 │-784 │-2009│-1448│400  │1892 │1703 │1448 │400  │-1892│
    │                  ││────────────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────│
    │                  ││────────────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────│
    │dct_mul           ││ 0          │5893.│8126.│7550.│6827.│1419.│4556.│3176.│1616.│5893.│6888.│3128.│-160.│-141.│-804.│-766.│-459.│5893.│4603.│-312.│-805.│-141.│1601.│7666.│6883.│5893.│1618.│
    │                  ││────────────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────│
    │                  ││──────────────────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────│
    │dct_mac           ││ 0                │5893.│1401.│2157.│2839.│2853.│3309.│3627.│3789.│5893.│1278.│1591.│1430.│1416.│6121.│-154.│-614.│5893.│1049.│7367.│-686.│-828.│7732.│8439.│1532.│5893.│
    │                  ││──────────────────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────│
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │x                 ││ 0                                                                                                                                                                      │
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────┬───────────────────────────────────────────────┬───────────────────────────────────────────────┬─────────────────│
    │y                 ││ 0                                                    │1                                              │2                                              │3                │
    │                  ││──────────────────────────────────────────────────────┴───────────────────────────────────────────────┴───────────────────────────────────────────────┴─────────────────│
    │                  ││────────────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────│
    │z                 ││ 0          │1    │2    │3    │4    │5    │6    │7    │0    │1    │2    │3    │4    │5    │6    │7    │0    │1    │2    │3    │4    │5    │6    │7    │0    │1    │2    │
    │                  ││────────────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────│
    │                  ││                                                                                                                                                                        │
    │                  ││                                                                                                                                                                        │
    │                  ││                                                                                                                                                                        │
    │                  ││                                                                                                                                                                        │
    │                  ││                                                                                                                                                                        │
    │                  ││                                                                                                                                                                        │
    │                  ││                                                                                                                                                                        │
    │                  ││                                                                                                                                                                        │
    └──────────────────┘└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]
;;
