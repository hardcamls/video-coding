(* Test forward and inverse DCTs. *)
open Core
open Hardcaml
open Hardcaml_waveterm
module Dct = Hardcaml_jpeg.Dct

(* 
  fdct
    - input 8 bits 
    - rom 12 bits
    - (12+8+3)=23 bit mac
    - 4 bit transpose fixed point -> (8+3+4)=15 bits
  - 2nd stage
    - input 15 bits 
    - rom 12 bits 
    - (12+15+3)=30 bits mac -> fixed point @ (12+4)=16 bits
    - output clipped to 12 bits

  idct
    - input 12 bits
    - rom 16 bits
    - (16+12+3)=31 bits
    - 4 bit transpose fixed point -> (31-16+4)=19 bits
  - 2nd stage 
    - input 19 bits 
    - rom 16 bits
    - (19+16+3)=38 bits mac -> fixed point @ (16+4)=20 bits
    - output clipped to 8 bits
*)

let expected inputs ~row =
  let v =
    Test_dct_fixed.eval_in_fixed_point
      ~fixed_prec:12
      ~coefs:Hardcaml_jpeg_model.Dct.Reference.Eight_point.inverse_transform_matrix.(row)
      ~inputs
  in
  v
;;

let%expect_test "inverse matrix, scaled" =
  let m = Hardcaml_jpeg_model.Dct.Reference.Eight_point.inverse_transform_matrix in
  let m =
    Array.map
      m
      ~f:(Array.map ~f:(fun f -> Float.(f * (2. ** of_int 12) |> round_nearest)))
  in
  print_s [%message (m : float array array)];
  [%expect
    {|
    (m
     ((1448 2009 1892 1703 1448 1138 784 400)
      (1448 1703 784 -400 -1448 -2009 -1892 -1138)
      (1448 1138 -784 -2009 -1448 400 1892 1703)
      (1448 400 -1892 -1138 1448 1703 -784 -2009)
      (1448 -400 -1892 1138 1448 -1703 -784 2009)
      (1448 -1138 -784 2009 -1448 -400 1892 -1703)
      (1448 -1703 784 400 -1448 2009 -1892 1138)
      (1448 -2009 1892 -1703 1448 -1138 784 -400))) |}]
;;

let display_rules =
  let module I = Display_rules.With_interface (Dct.I) in
  let module O = Display_rules.With_interface (Dct.O) in
  List.concat
    [ I.default ()
    ; O.default ()
    ; Display_rule.
        [ port_name_is "dct_coef" ~wave_format:Int
        ; port_name_is "dct_mul" ~wave_format:Int
        ; port_name_is "dct_mac" ~wave_format:Int
        ; port_name_is "x" ~wave_format:Unsigned_int
        ; port_name_is "y" ~wave_format:Unsigned_int
        ; port_name_is "z" ~wave_format:Unsigned_int
        ]
    ]
;;

let%expect_test "test dct" =
  let module Sim = Cyclesim.With_interface (Dct.I) (Dct.O) in
  let scope = Scope.create ~flatten_design:true () in
  let sim = Sim.create ~config:Cyclesim.Config.trace_all (Dct.create scope) in
  let waves, sim = Waveform.create sim in
  let inputs = Cyclesim.inputs sim in
  let idct_inputs =
    Array.init 8 ~f:(fun _ -> Array.init 8 ~f:(fun _ -> Random.int 400 - 200))
  in
  let expected =
    Array.init 8 ~f:(fun r ->
        Array.init 8 ~f:(fun c -> (expected idct_inputs.(r) ~row:c).scaled_and_clipped))
  in
  print_s [%message (expected : int array array)];
  [%expect
    {|
    (expected
     ((-10 124 -128 127 -31 23 -16 -128) (-128 110 64 63 -63 -31 -124 -32)
      (37 127 -110 -128 24 -127 65 -107) (4 55 -128 86 -26 -53 -68 -18)
      (-128 -91 53 103 127 -35 -18 127) (-128 -67 124 -128 -20 110 -42 71)
      (14 -5 47 -128 33 74 -15 -128) (59 74 -43 16 -111 -128 57 -1))) |}];
  let outputs = Cyclesim.outputs sim in
  let results = ref [] in
  let cycle () =
    if Bits.to_bool !(outputs.pixel_write)
    then results := Bits.to_sint !(outputs.pixel) :: !results;
    let coef_address = outputs.coef_address in
    Cyclesim.cycle sim;
    let row, col =
      Bits.(to_int !coef_address.:[5, 3]), Bits.(to_int !coef_address.:[2, 0])
    in
    inputs.coef := Bits.of_int ~width:12 idct_inputs.(row).(col)
  in
  inputs.start := Bits.vdd;
  cycle ();
  inputs.start := Bits.gnd;
  for _ = 0 to 1200 do
    cycle ()
  done;
  let results =
    let results = List.rev !results |> Array.of_list in
    Array.init 16 ~f:(fun r -> Array.init 8 ~f:(fun c -> results.(c + (r * 8))))
  in
  print_s [%message (results : Int.t array array)];
  Waveform.print
    ~display_width:190
    ~display_height:50
    ~wave_width:3
    ~start_cycle:(8 * 127)
    ~display_rules
    waves;
  [%expect
    {|
    (results
     ((-10 124 -128 127 -31 23 -16 -128) (-128 110 64 63 -63 -31 -124 -32)
      (37 127 -110 -128 24 -127 65 -107) (4 55 -128 86 -26 -53 -68 -18)
      (-128 -91 53 103 127 -35 -18 127) (-128 -67 124 -128 -20 110 -42 71)
      (14 -5 47 -128 33 74 -15 -128) (59 74 -43 16 -111 -128 57 -1)
      (-123 4 -47 90 75 -41 -91 61) (53 127 127 -128 52 77 11 17)
      (-75 -14 5 -128 -86 -49 127 -32) (-9 26 -1 -91 -77 127 51 127)
      (-37 17 -128 -18 127 -19 -67 21) (-128 81 64 -64 127 50 37 20)
      (-128 -128 26 127 -128 -18 -84 -111) (-49 -128 -26 -34 -128 -128 -51 125)))
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   │
    │                  ││    └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───│
    │clear             ││                                                                                                                                                                        │
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │start             ││                                                                                                                                                                        │
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────────────────────────────────────────────────────────────────────────────────────────────│
    │coef              ││ 006    │F3B    │F9F    │077    │F61    │067    │05D    │056    │006    │FE6                                                                                            │
    │                  ││────────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────────────────────────────────────────────────────────────────────│
    │pixel             ││ C6     │F3     │CB     │CD     │BA     │EA     │21     │63     │7F     │6E     │7E     │7D     │F7                                                                     │
    │                  ││────────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │pixel_address     ││ 00                                                                                                                                                                     │
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │pixel_write       ││                        ┌───────┐                                                       ┌───────┐                                                                       │
    │                  ││────────────────────────┘       └───────────────────────────────────────────────────────┘       └───────────────────────────────────────────────────────────────────────│
    │                  ││────────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────────────────────────────────────────────────────────────────────────────────────────────│
    │coef_address      ││ 3F     │07     │0F     │17     │1F     │27     │2F     │37     │3F     │00                                                                                             │
    │                  ││────────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────────────────────────────────────────────────────────────────────────────────────────│
    │coef_read         ││────────────────────────────────────────────────────────────────────────┐                                                                                               │
    │                  ││                                                                        └───────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────────────────────────────────────────────────────────────────────────────────────────────│
    │dct_coef          ││ 1138   │1448   │-2009  │1892   │-1703  │1448   │-1138  │784    │-400   │1448                                                                                           │
    │                  ││────────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────────────────────────────────────────────────────────────────────────────────────│
    │dct_mul           ││ -162712│6828   │-285256│194873 │225148 │270777 │149144 │-105834│67424  │-2400  │-37648                                                                                 │
    │                  ││────────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────────────────────────────────────────────────────────────────────────────│
    │dct_mac           ││ -52676 │-215388│-208560│-285256│-90383 │134765 │405542 │554686 │448852 │516276 │513876 │-37648                                                                         │
    │                  ││────────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────────┬───────────────────────────────────────────────────────────────────────────────────────────────│
    │x                 ││ 7                                                                      │0                                                                                              │
    │                  ││────────────────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────┬───────────────────────────────────────────────────────────────┬───────────────────────────────────────────────────────────────────────────────────────────────│
    │y                 ││ 6      │7                                                              │0                                                                                              │
    │                  ││────────┴───────────────────────────────────────────────────────────────┴───────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────┬───────────────────────────────────────────────────────────────────────────────────────────────│
    │z                 ││ 7      │0      │1      │2      │3      │4      │5      │6      │7      │0                                                                                              │
    │                  ││────────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────┴───────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                                                                                                                        │
    │                  ││                                                                                                                                                                        │
    │                  ││                                                                                                                                                                        │
    │                  ││                                                                                                                                                                        │
    │                  ││                                                                                                                                                                        │
    │                  ││                                                                                                                                                                        │
    │                  ││                                                                                                                                                                        │
    │                  ││                                                                                                                                                                        │
    └──────────────────┘└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]
;;
