open! Core
open Hardcaml
open Hardcaml_waveterm
module Vld = Hardcaml_jpeg.Vld.With_reader
module Sim = Cyclesim.With_interface (Vld.I) (Vld.O)

(* Uses Mosue480.jpg which is a tiny test jpeg we can use for tests. *)
let load_jpeg () =
  In_channel.with_file ~binary:true "Mouse480.jpg" ~f:In_channel.input_all
;;

let test_vld ?(waves = true) bitstream =
  let sim =
    Sim.create
      ~config:Cyclesim.Config.trace_all
      (Vld.create
         (Scope.create ~auto_label_hierarchical_ports:true ~flatten_design:true ()))
  in
  let waves, sim =
    if waves
    then (
      let waves, sim = Waveform.create sim in
      Some waves, sim)
    else None, sim
  in
  let inputs = Cyclesim.inputs sim in
  let outputs = Cyclesim.outputs sim in
  inputs.clocking.clear := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.clocking.clear := Bits.gnd;
  inputs.start := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.start := Bits.gnd;
  inputs.bits_in_available := Bits.vdd;
  let pos = ref 0 in
  let cycles = ref 0 in
  while !cycles < 1_000 do
    let bits =
      Bits.concat_lsb [ Bits.of_char bitstream.[!pos]; Bits.of_char bitstream.[!pos + 1] ]
    in
    inputs.bits_in := bits;
    Cyclesim.cycle sim;
    if Bits.to_bool !(outputs.read_bits_in) then pos := !pos + 2;
    cycles := !cycles + 1
  done;
  Cyclesim.cycle sim;
  Cyclesim.cycle sim;
  waves
;;

let%expect_test "debug vld" =
  let bitstream = load_jpeg () in
  print_s [%message (String.subo ~len:200 bitstream : String.Hexdump.t)];
  [%expect
    {|
    ("String.subo ~len:200 bitstream"
     ("00000000  ff d8 ff e0 00 10 4a 46  49 46 00 01 01 01 00 48  |......JFIF.....H|"
      "00000010  00 48 00 00 ff db 00 43  00 28 1c 1e 23 1e 19 28  |.H.....C.(..#..(|"
      "00000020  23 21 23 2d 2b 28 30 3c  64 41 3c 37 37 3c 7b 58  |#!#-+(0<dA<77<{X|"
      "00000030  5d 49 64 91 80 99 96 8f  80 8c 8a a0 b4 e6 c3 a0  |]Id.............|"
      "00000040  aa da ad 8a 8c c8 ff cb  da ee f5 ff ff ff 9b c1  |................|"
      "00000050  ff ff ff fa ff e6 fd ff  f8 ff db 00 43 01 2b 2d  |............C.+-|"
      "00000060  2d 3c 35 3c 76 41 41 76  f8 a5 8c a5 f8 f8 f8 f8  |-<5<vAAv........|"
      "00000070  f8 f8 f8 f8 f8 f8 f8 f8  f8 f8 f8 f8 f8 f8 f8 f8  |................|"
      "00000080  f8 f8 f8 f8 f8 f8 f8 f8  f8 f8 f8 f8 f8 f8 f8 f8  |................|"
      "00000090  f8 f8 f8 f8 f8 f8 f8 f8  f8 f8 f8 f8 f8 f8 ff c0  |................|"
      "000000a0  00 11 08 01 40 01 e0 03  01 22 00 02 11 01 03 11  |....@....\"......|"
      "000000b0  01 ff c4 00 1a 00 00 03  01 01 01 01 00 00 00 00  |................|"
      "000000c0  00 00 00 00 00 00 00 01                           |........|")) |}];
  Caller_id.set_mode Full_trace;
  let waves = test_vld bitstream in
  Option.iter
    waves
    ~f:
      (Waveform.print
         ~display_width:120
         ~display_height:150
         ~wave_width:2
         ~start_cycle:20);
  [%expect{|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌─│
    │                  ││   └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘ │
    │clear             ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────┬───────────┬─────┬─────┬───────────────────────┬───────────┬───────────┬───────────┬───────│
    │bits_in           ││ DBFF │4300       │2800 │1E1C │1E23                   │2819       │2123       │2D23       │282B   │
    │                  ││──────┴───────────┴─────┴─────┴───────────────────────┴───────────┴───────────┴───────────┴───────│
    │bits_in_available ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                                                  │
    │start             ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$code          ││ 0000                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$code_base_addr││ 0000                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$code_length_mi││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$code_write    ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────┬───────────┬─────┬───────────┬─────┬───────────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─│
    │dht$data          ││ 48   │00         │FF   │00         │80   │28         │1C   │1E   │23   │1E   │19   │28   │23   │2│
    │                  ││──────┴───────────┴─────┴───────────┴─────┴───────────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$data_address  ││ 0000                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$data_write    ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$hdr$destinatio││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$hdr$length    ││ 0000                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$hdr$table_clas││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────┬───────────┬─────┬───────────┬─────┬───────────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─│
    │dht$num_codes_at_l││ 48   │00         │FF   │00         │80   │28         │1C   │1E   │23   │1E   │19   │28   │23   │2│
    │                  ││──────┴───────────┴─────┴───────────┴─────┴───────────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─│
    │done_             ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────┬───────────┬─────┬───────────┬─────┬───────────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─│
    │dqt$element       ││ 0048 │0000       │00FF │0000       │0080 │0028       │001C │001E │0023 │001E │0019 │0028 │0023 │0│
    │                  ││──────┴───────────┴─────┴───────────┴─────┴───────────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─│
    │                  ││──────────────────────────────────────────────────────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─│
    │dqt$element_addres││ 00                                                   │01   │02   │03   │04   │05   │06   │07   │0│
    │                  ││──────────────────────────────────────────────────────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dqt$element_precis││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dqt$element_write ││                                                ┌─────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────┘                                                 │
    │                  ││──────────────────────────────┬───────────────────────────────────────────────────────────────────│
    │dqt$length        ││ 0000                         │0043                                                               │
    │                  ││──────────────────────────────┴───────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dqt$table_identifi││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │error_binary_varia││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │read_bits_in      ││      ┌─────┐     ┌─────────────────┐                 ┌─────┐     ┌─────┐     ┌─────┐     ┌─────┐ │
    │                  ││──────┘     └─────┘                 └─────────────────┘     └─────┘     └─────┘     └─────┘     └─│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$component_addr││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$component_writ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$height        ││ 0000                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$horizontal_sam││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$identifier    ││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$length        ││ 0000                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$number_of_comp││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$quantization_t││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$sample_precisi││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$vertical_sampl││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$width         ││ 0000                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$ac_coef_select││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$dc_coef_select││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$end_of_predict││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$length        ││ 0000                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$number_of_imag││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$selector      ││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$start_of_predi││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$successive_app││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$successive_app││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$write_scan_sel││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │gnd               ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────┬───────────┬─────┬─────┬───────────────────────┬───────────┬───────────┬───────────┬─│
    │reader$bits_buffer││ DBFF000048.│4300DBFF00.│2800.│1E1C.│1E231E1C2800           │28191E231E.│212328191E.│2D23212328.│2│
    │                  ││────────────┴───────────┴─────┴─────┴───────────────────────┴───────────┴───────────┴───────────┴─│
    │                  ││──────┬─────┬─────┬─────────────────┬─────┬───────────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─│
    │reader$bits_buffer││ 08   │10   │08   │10               │04   │08         │10   │08   │10   │08   │10   │08   │10   │0│
    │                  ││──────┴─────┴─────┴─────────────────┴─────┴───────────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─│
    │                  ││──────────────────┬───────────┬───────────┬─────┬─────────────────────────────────────────────────│
    │reader$i$advance_b││ 08               │10         │04         │00   │08                                               │
    │                  ││──────────────────┴───────────┴───────────┴─────┴─────────────────────────────────────────────────│
    │                  ││──────┬───────────┬─────┬─────┬───────────────────────┬───────────┬───────────┬───────────┬───────│
    │reader$i$bits_in  ││ DBFF │4300       │2800 │1E1C │1E23                   │2819       │2123       │2D23       │282B   │
    │                  ││──────┴───────────┴─────┴─────┴───────────────────────┴───────────┴───────────┴───────────┴───────│
    │reader$i$bits_in_a││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                                                  │
    │reader$i$clear    ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │reader$i$clock    ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────┬─────┬─────┬─────────────────┬─────┬───────────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─│
    │reader$num_bits_av││ 28   │20   │28   │20               │2C   │28         │20   │28   │20   │28   │20   │28   │20   │2│
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]
;;
