open! Core
open Hardcaml
open Hardcaml_waveterm
open Hardcaml_jpeg
module Decoder = Bytestream_decoder
module Sim = Cyclesim.With_interface (Decoder.I) (Decoder.O)

let display_rules =
  let module I = Display_rules.With_interface (Decoder.I) in
  let module O = Display_rules.With_interface (Decoder.O) in
  List.concat
    Display_rule.
      [ I.default ()
      ; [ port_name_is "STATE" ~wave_format:(Index Decoder.State.names) ]
      ; O.default ()
      ; [ default ]
      ]
;;

let read_header (outputs : _ Decoder.O.t) =
  let unref x = Bits.to_int !x in
  let components = ref [] in
  let scan_selector = ref [] in
  let quant_tables = ref [] in
  let cycle () =
    let sof = outputs.markers.sof in
    if Bits.to_bool !(sof.component_write)
    then components := Markers.Component.Fields.map sof.component ~f:unref :: !components;
    let sos = outputs.markers.sos in
    if Bits.to_bool !(sos.write_scan_selector)
    then
      scan_selector
        := Markers.Scan_selector.Fields.map sos.scan_selector ~f:unref :: !scan_selector;
    let dqt = outputs.markers.dqt in
    if Bits.to_bool !(dqt.element_write)
    then
      quant_tables
        := ( unref dqt.fields.table_identifier
           , unref dqt.element_address
           , unref dqt.element )
           :: !quant_tables
  in
  let print () =
    let sof =
      outputs.markers.sof.frame_header |> Markers.Sof.Header.Fields.map ~f:unref
    in
    let sof_components = List.rev !components in
    let sos_header =
      outputs.markers.sos.header |> Markers.Sos.Header.Fields.map ~f:unref
    in
    let sos_footer =
      outputs.markers.sos.footer |> Markers.Sos.Footer.Fields.map ~f:unref
    in
    let scan_selector = List.rev !scan_selector in
    let quant_tables =
      List.group !quant_tables ~break:(fun (a, _, _) (b, _, _) -> a <> b)
      |> List.map ~f:(List.sort ~compare:[%compare: int * int * int])
    in
    print_s
      [%message
        "header"
          (sof : int Markers.Sof.Header.Fields.t)
          (sof_components : int Markers.Component.Fields.t list)
          (sos_header : int Markers.Sos.Header.Fields.t)
          (scan_selector : int Markers.Scan_selector.Fields.t list)
          (sos_footer : int Markers.Sos.Footer.Fields.t)
          (quant_tables : (int * int * int) list list)]
  in
  cycle, print
;;

let test ?(waves = false) jpeg =
  let jpeg = Util.load_jpeg_file jpeg in
  let bits = Hardcaml_jpeg_model.Bitstream_reader.From_string.get_buffer jpeg in
  let sim =
    Sim.create
      ~config:Cyclesim.Config.trace_all
      (Decoder.create (Scope.create ~flatten_design:true ()))
  in
  let waves, sim =
    if waves
    then (
      let waves, sim = Waveform.create sim in
      Some waves, sim)
    else None, sim
  in
  let inputs = Cyclesim.inputs sim in
  let outputs = Cyclesim.outputs sim in
  let outputs_before = Cyclesim.outputs ~clock_edge:Before sim in
  inputs.clocking.clear := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.clocking.clear := Bits.gnd;
  inputs.start := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.start := Bits.gnd;
  inputs.bits_ready := Bits.vdd;
  let cycle_headers, print_headers = read_header outputs in
  let num_cycles = ref 0 in
  let pos = ref 0 in
  let cycle () =
    Cyclesim.cycle sim;
    cycle_headers ();
    if Bits.to_bool !(outputs_before.jpeg_ready)
    then (
      (inputs.jpeg_valid := Bits.vdd;
       inputs.jpeg
         := try Bits.of_char bits.[!pos] with
            | _ -> Bits.zero 8);
      Int.incr pos);
    Int.incr num_cycles
  in
  while (not (Bits.to_bool !(outputs.done_))) && !num_cycles < 10_000 do
    cycle ()
  done;
  Cyclesim.cycle sim;
  Cyclesim.cycle sim;
  print_headers ();
  waves
;;

let%expect_test "test reader" =
  let waves = test ~waves:true "Mouse480.jpg" in
  Option.iter
    waves
    ~f:
      (Waveform.print
         ~display_width:100
         ~display_height:150
         ~wave_width:(-100)
         ~start_cycle:0
         ~display_rules);
  [%expect
    {|
    (header
     (sof
      ((length 17) (sample_precision 8) (height 320) (width 480)
       (number_of_components 3)))
     (sof_components
      (((identifier 1) (vertical_sampling_factor 2)
        (horizontal_sampling_factor 2) (quantization_table_identifier 0))
       ((identifier 2) (vertical_sampling_factor 1)
        (horizontal_sampling_factor 1) (quantization_table_identifier 1))
       ((identifier 3) (vertical_sampling_factor 1)
        (horizontal_sampling_factor 1) (quantization_table_identifier 1))))
     (sos_header ((length 12) (number_of_image_components 3)))
     (scan_selector
      (((selector 1) (dc_coef_selector 0) (ac_coef_selector 0))
       ((selector 2) (dc_coef_selector 1) (ac_coef_selector 1))
       ((selector 3) (dc_coef_selector 1) (ac_coef_selector 1))))
     (sos_footer
      ((start_of_predictor_selection 0) (end_of_predictor_selection 63)
       (successive_approximation_bit_high 0)
       (successive_approximation_bit_low 0)))
     (quant_tables
      (((1 0 43) (1 1 43) (1 2 45) (1 3 45) (1 4 60) (1 5 53) (1 6 60) (1 7 118)
        (1 8 65) (1 9 65) (1 10 118) (1 11 248) (1 12 165) (1 13 140) (1 14 165)
        (1 15 248) (1 16 248) (1 17 248) (1 18 248) (1 19 248) (1 20 248)
        (1 21 248) (1 22 248) (1 23 248) (1 24 248) (1 25 248) (1 26 248)
        (1 27 248) (1 28 248) (1 29 248) (1 30 248) (1 31 248) (1 32 248)
        (1 33 248) (1 34 248) (1 35 248) (1 36 248) (1 37 248) (1 38 248)
        (1 39 248) (1 40 248) (1 41 248) (1 42 248) (1 43 248) (1 44 248)
        (1 45 248) (1 46 248) (1 47 248) (1 48 248) (1 49 248) (1 50 248)
        (1 51 248) (1 52 248) (1 53 248) (1 54 248) (1 55 248) (1 56 248)
        (1 57 248) (1 58 248) (1 59 248) (1 60 248) (1 61 248) (1 62 248)
        (1 63 248))
       ((0 0 40) (0 1 40) (0 2 28) (0 3 30) (0 4 35) (0 5 30) (0 6 25) (0 7 40)
        (0 8 35) (0 9 33) (0 10 35) (0 11 45) (0 12 43) (0 13 40) (0 14 48)
        (0 15 60) (0 16 100) (0 17 65) (0 18 60) (0 19 55) (0 20 55) (0 21 60)
        (0 22 123) (0 23 88) (0 24 93) (0 25 73) (0 26 100) (0 27 145) (0 28 128)
        (0 29 153) (0 30 150) (0 31 143) (0 32 128) (0 33 140) (0 34 138)
        (0 35 160) (0 36 180) (0 37 230) (0 38 195) (0 39 160) (0 40 170)
        (0 41 218) (0 42 173) (0 43 138) (0 44 140) (0 45 200) (0 46 255)
        (0 47 203) (0 48 218) (0 49 238) (0 50 245) (0 51 255) (0 52 255)
        (0 53 255) (0 54 155) (0 55 193) (0 56 255) (0 57 255) (0 58 255)
        (0 59 250) (0 60 255) (0 61 230) (0 62 253) (0 63 255)))))
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────┐
    │clock             ││╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥│
    │                  ││╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨│
    │clear             ││╥                                                                             │
    │                  ││╨──────────────────────────────────────────────────────────────────           │
    │start             ││╥                                                                             │
    │                  ││╨──────────────────────────────────────────────────────────────────           │
    │                  ││╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥           │
    │jpeg              ││║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║           │
    │                  ││╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨           │
    │jpeg_valid        ││╥──────────────────────────────────────────────────────────────────           │
    │                  ││╨                                                                             │
    │bits_ready        ││╥──────────────────────────────────────────────────────────────────           │
    │                  ││╨                                                                             │
    │                  ││╥╥╥╥────────────────╥─────╥────────╥───╥─╥────╥╥─╥──╥────────╥╥──╥╥           │
    │STATE             ││║║║║ Entropy_coded_.║ Ent.║ Entrop.║ E.║ ║ En.║║ ║ .║ Entrop.║║ .║║           │
    │                  ││╨╨╨╨────────────────╨─────╨────────╨───╨─╨────╨╨─╨──╨────────╨╨──╨╨           │
    │jpeg_ready        ││╥╥╥╥──────────────────────────────────────────────────────────────╥           │
    │                  ││╨╨╨╨                                                              ╨           │
    │done_             ││╥                                                                 ╥           │
    │                  ││╨─────────────────────────────────────────────────────────────────╨           │
    │                  ││───────────────────────────────────────────────────────────────────           │
    │bits              ││ 00                                                                           │
    │                  ││───────────────────────────────────────────────────────────────────           │
    │bits_valid        ││   ╥────────────────╥─────╥────────╥───╥─╥────╥╥─╥──╥────────╥╥──╥╥           │
    │                  ││───╨                ╨     ╨        ╨   ╨ ╨    ╨╨ ╨  ╨        ╨╨  ╨╨           │
    │                  ││─╥─────────────────────────────────────────────────────────────────           │
    │sof$length        ││ ║ 0011                                                                       │
    │                  ││─╨─────────────────────────────────────────────────────────────────           │
    │                  ││─╥─────────────────────────────────────────────────────────────────           │
    │sof$sample_precisi││ ║ 08                                                                         │
    │                  ││─╨─────────────────────────────────────────────────────────────────           │
    │                  ││─╥─────────────────────────────────────────────────────────────────           │
    │sof$height        ││ ║ 0140                                                                       │
    │                  ││─╨─────────────────────────────────────────────────────────────────           │
    │                  ││─╥─────────────────────────────────────────────────────────────────           │
    │sof$width         ││ ║ 01E0                                                                       │
    │                  ││─╨─────────────────────────────────────────────────────────────────           │
    │                  ││─╥─────────────────────────────────────────────────────────────────           │
    │sof$number_of_comp││ ║ 03                                                                         │
    │                  ││─╨─────────────────────────────────────────────────────────────────           │
    │                  ││─╥─────────────────────────────────────────────────────────────────           │
    │sof$identifier    ││ ║ 03                                                                         │
    │                  ││─╨─────────────────────────────────────────────────────────────────           │
    │                  ││─╥─────────────────────────────────────────────────────────────────           │
    │sof$vertical_sampl││ ║ 1                                                                          │
    │                  ││─╨─────────────────────────────────────────────────────────────────           │
    │                  ││─╥─────────────────────────────────────────────────────────────────           │
    │sof$horizontal_sam││ ║ 1                                                                          │
    │                  ││─╨─────────────────────────────────────────────────────────────────           │
    │                  ││─╥─────────────────────────────────────────────────────────────────           │
    │sof$quantization_t││ ║ 01                                                                         │
    │                  ││─╨─────────────────────────────────────────────────────────────────           │
    │                  ││─╥─────────────────────────────────────────────────────────────────           │
    │sof$component_addr││ ║ 0                                                                          │
    │                  ││─╨─────────────────────────────────────────────────────────────────           │
    │sof$component_writ││ ╥                                                                            │
    │                  ││─╨─────────────────────────────────────────────────────────────────           │
    │                  ││───╥───────────────────────────────────────────────────────────────           │
    │sos$length        ││ 0.║ 000C                                                                     │
    │                  ││───╨───────────────────────────────────────────────────────────────           │
    │                  ││───╥───────────────────────────────────────────────────────────────           │
    │sos$number_of_imag││ 00║ 03                                                                       │
    │                  ││───╨───────────────────────────────────────────────────────────────           │
    │                  ││───╥───────────────────────────────────────────────────────────────           │
    │sos$selector      ││ 00║ 03                                                                       │
    │                  ││───╨───────────────────────────────────────────────────────────────           │
    │                  ││───╥───────────────────────────────────────────────────────────────           │
    │sos$dc_coef_select││ 0 ║ 1                                                                        │
    │                  ││───╨───────────────────────────────────────────────────────────────           │
    │                  ││───╥───────────────────────────────────────────────────────────────           │
    │sos$ac_coef_select││ 0 ║ 1                                                                        │
    │                  ││───╨───────────────────────────────────────────────────────────────           │
    │sos$write_scan_sel││   ╥                                                                          │
    │                  ││───╨───────────────────────────────────────────────────────────────           │
    │                  ││───────────────────────────────────────────────────────────────────           │
    │sos$start_of_predi││ 00                                                                           │
    │                  ││───────────────────────────────────────────────────────────────────           │
    │                  ││───╥───────────────────────────────────────────────────────────────           │
    │sos$end_of_predict││ 00║ 3F                                                                       │
    │                  ││───╨───────────────────────────────────────────────────────────────           │
    │                  ││───╥───────────────────────────────────────────────────────────────           │
    │sos$successive_app││ 0 ║ 0                                                                        │
    │                  ││───╨───────────────────────────────────────────────────────────────           │
    │                  ││───╥───────────────────────────────────────────────────────────────           │
    │sos$successive_app││ 0 ║ 0                                                                        │
    │                  ││───╨───────────────────────────────────────────────────────────────           │
    │                  ││╥──────────────────────────────────────────────────────────────────           │
    │dqt$length        ││║ 0043                                                                        │
    │                  ││╨──────────────────────────────────────────────────────────────────           │
    │                  ││╥──────────────────────────────────────────────────────────────────           │
    │dqt$element_precis││║ 0                                                                           │
    │                  ││╨──────────────────────────────────────────────────────────────────           │
    │                  ││╥──────────────────────────────────────────────────────────────────           │
    │dqt$table_identifi││║ 1                                                                           │
    │                  ││╨──────────────────────────────────────────────────────────────────           │
    │                  ││╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥           │
    │dqt$element       ││║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║           │
    │                  ││╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨           │
    │                  ││╥╥─────────────────────────────────────────────────────────────────           │
    │dqt$element_addres││║║ 00                                                                         │
    │                  ││╨╨─────────────────────────────────────────────────────────────────           │
    │dqt$element_write ││╥╥                                                                            │
    │                  ││╨╨─────────────────────────────────────────────────────────────────           │
    │                  ││─╥╥╥───────────────────────────────────────────────────────────────           │
    │dht$hdr$length    ││ ║║║ 0016                                                                     │
    │                  ││─╨╨╨───────────────────────────────────────────────────────────────           │
    │                  ││─╥╥╥───────────────────────────────────────────────────────────────           │
    │dht$hdr$table_clas││ ║║║ 1                                                                        │
    │                  ││─╨╨╨───────────────────────────────────────────────────────────────           │
    │                  ││─╥╥╥───────────────────────────────────────────────────────────────           │
    │dht$hdr$destinatio││ ║║║ 1                                                                        │
    │                  ││─╨╨╨───────────────────────────────────────────────────────────────           │
    │                  ││─╥╥╥───────────────────────────────────────────────────────────────           │
    │dht$code_length_mi││ ║║║ 0                                                                        │
    │                  ││─╨╨╨───────────────────────────────────────────────────────────────           │
    │                  ││╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥           │
    │dht$num_codes_at_l││║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║           │
    │                  ││╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨           │
    │                  ││──╥╥───────────────────────────────────────────────────────────────           │
    │dht$code          ││ .║║ C000                                                                     │
    │                  ││──╨╨───────────────────────────────────────────────────────────────           │
    │                  ││──╥╥───────────────────────────────────────────────────────────────           │
    │dht$code_base_addr││ .║║ 0003                                                                     │
    │                  ││──╨╨───────────────────────────────────────────────────────────────           │
    │dht$code_write    ││ ╥╥╥                                                                          │
    │                  ││─╨╨╨───────────────────────────────────────────────────────────────           │
    │                  ││╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥           │
    │dht$data          ││║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║║           │
    │                  ││╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨           │
    │                  ││──╥╥───────────────────────────────────────────────────────────────           │
    │dht$data_address  ││ .║║ 0003                                                                     │
    │                  ││──╨╨───────────────────────────────────────────────────────────────           │
    │dht$data_write    ││  ╥╥                                                                          │
    │                  ││──╨╨───────────────────────────────────────────────────────────────           │
    │                  ││╥──────────────────────────────────────────────────────────────────           │
    │SKIP_COUNT        ││║ 0000                                                                        │
    │                  ││╨──────────────────────────────────────────────────────────────────           │
    │                  ││╥──────────────────────────────────────────────────────────────────           │
    │SKIP_LENGTH       ││║ 0010                                                                        │
    │                  ││╨──────────────────────────────────────────────────────────────────           │
    │gnd               ││                                                                              │
    │                  ││───────────────────────────────────────────────────────────────────           │
    │vdd               ││───────────────────────────────────────────────────────────────────           │
    │                  ││                                                                              │
    │                  ││                                                                              │
    │                  ││                                                                              │
    │                  ││                                                                              │
    │                  ││                                                                              │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────┘ |}]
;;
