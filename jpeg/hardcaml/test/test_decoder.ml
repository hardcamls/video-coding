open! Core
open! Hardcaml
open! Hardcaml_waveterm
module Decoder = Hardcaml_jpeg.Decoder.Core
module Sim = Cyclesim.With_interface (Decoder.I) (Decoder.O)

let%expect_test "" =
  let sim = Sim.create (Decoder.create (Scope.create ~flatten_design:true ())) in
  let waves, sim = Waveform.create sim in
  let inputs = Cyclesim.inputs sim in
  inputs.clocking.clear := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.clocking.clear := Bits.gnd;
  inputs.start := Bits.gnd;
  for _ = 0 to 10 do
    Cyclesim.cycle sim
  done;
  Waveform.print ~display_height:50 ~display_width:120 ~wave_width:2 ~start_cycle:0 waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌─│
    │                  ││   └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘ │
    │clear             ││──────┐                                                                                           │
    │                  ││      └─────────────────────────────────────────────────────────────────                          │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │bits              ││ 0000                                                                                             │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │dht$code          ││ 0000                                                                                             │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │dht$code_base_addr││ 0000                                                                                             │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │dht$code_length_mi││ 0                                                                                                │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │dht$code_write    ││                                                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │dht$data          ││ 00                                                                                               │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │dht$data_address  ││ 0000                                                                                             │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │dht$data_write    ││                                                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │dht$hdr$destinatio││ 0                                                                                                │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │dht$hdr$table_clas││ 0                                                                                                │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │dht$num_codes_at_l││ 00                                                                                               │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │dqt$element       ││ 0000                                                                                             │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │dqt$element_addres││ 00                                                                                               │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │dqt$element_write ││                                                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │dqt$table_identifi││ 0                                                                                                │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    │start             ││                                                                                                  │
    │                  ││────────────────────────────────────────────────────────────────────────                          │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]
;;
