open! Core
open Hardcaml
open Hardcaml_jpeg
open Hardcaml_waveterm
module Scan_controller = Scan_controller.New
module Sim = Cyclesim.With_interface (Scan_controller.I) (Scan_controller.O)

let display_rules =
  let port ?(wave_format = Wave_format.Bit_or Hex) name =
    Display_rule.port_name_is name ~wave_format
  in
  Display_rule.
    [ port "clock"
    ; port "clear"
    ; port "start"
    ; port "STATE" ~wave_format:(Index Scan_controller.State.strings)
    ; port "scan_address" ~wave_format:Unsigned_int
    ; port "blk_x" ~wave_format:Unsigned_int
    ; port "blk_y" ~wave_format:Unsigned_int
    ; port "x_pos" ~wave_format:Unsigned_int
    ; port "y_pos" ~wave_format:Unsigned_int
    ; port "max_horz_sampling" ~wave_format:Unsigned_int
    ; port "max_vert_sampling" ~wave_format:Unsigned_int
    ; port "width_in_blocks" ~wave_format:Unsigned_int
    ; port "height_in_blocks" ~wave_format:Unsigned_int
    ; port "component_width" ~wave_format:Unsigned_int
    ; port "component_height" ~wave_format:Unsigned_int
    ; port_name_matches
        (Re.compile (Re.Posix.re "^scan\\$"))
        ~wave_format:(Bit_or Unsigned_int)
    ; port_name_matches (Re.compile (Re.Posix.re "^sos\\$")) ~wave_format:(Bit_or Hex)
    ; port_name_matches (Re.compile (Re.Posix.re "^sof\\$")) ~wave_format:(Bit_or Hex)
    ]
;;

let ( <--. ) a b = a := Bits.of_int ~width:(Bits.width !a) b

let%expect_test "" =
  let sim =
    Sim.create
      ~config:Cyclesim.Config.trace_all
      (Scan_controller.create (Scope.create ()))
  in
  let waves, sim = Waveform.create sim in
  let inputs = Cyclesim.inputs sim in
  inputs.clocking.clear := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.clocking.clear := Bits.gnd;
  inputs.sof.frame_header.width <--. 16;
  inputs.sof.frame_header.height <--. 32;
  let write_component ~address ~ident ~vert ~horz ~qtab =
    inputs.sof.component.identifier <--. ident;
    inputs.sof.component.fields.vertical_sampling_factor <--. vert;
    inputs.sof.component.fields.horizontal_sampling_factor <--. horz;
    inputs.sof.component.fields.quantization_table_identifier <--. qtab;
    inputs.sof.component_address <--. address;
    inputs.sof.component_write := Bits.vdd;
    Cyclesim.cycle sim;
    inputs.sof.component_write := Bits.gnd
  in
  write_component ~address:0 ~ident:7 ~vert:2 ~horz:2 ~qtab:0;
  write_component ~address:1 ~ident:9 ~vert:2 ~horz:1 ~qtab:1;
  write_component ~address:2 ~ident:2 ~vert:1 ~horz:1 ~qtab:1;
  inputs.sos.header.number_of_image_components <--. 3;
  let write_scan ~ident ~dc ~ac =
    inputs.sos.scan_selector.identifier <--. ident;
    inputs.sos.scan_selector.fields.dc_coef_selector <--. dc;
    inputs.sos.scan_selector.fields.ac_coef_selector <--. ac;
    inputs.sos.write_scan_selector := Bits.vdd;
    Cyclesim.cycle sim;
    inputs.sos.write_scan_selector := Bits.gnd
  in
  write_scan ~ident:9 ~dc:0 ~ac:0;
  write_scan ~ident:2 ~dc:1 ~ac:1;
  write_scan ~ident:7 ~dc:1 ~ac:1;
  Cyclesim.cycle sim;
  inputs.start := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.start := Bits.gnd;
  for _ = 0 to 25 do
    Cyclesim.cycle sim
  done;
  Waveform.print ~display_width:160 ~display_height:70 ~wave_width:1 ~display_rules waves;
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
    │clear             ││────┐                                                                                                                                     │
    │                  ││    └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │start             ││                                ┌───┐                                                                                                     │
    │                  ││────────────────────────────────┘   └─────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────┬───┬───────┬───┬───┬───┬───────────────┬───┬───────┬───┬───┬───┬───────────────┬─────────────────────│
    │STATE             ││ Headers                            │Co.│Blocks │Co.│Bl.│Co.│Blocks         │Co.│Blocks │Co.│Bl.│Co.│Blocks         │Headers              │
    │                  ││────────────────────────────────────┴───┴───────┴───┴───┴───┴───────────────┴───┴───────┴───┴───┴───┴───────────────┴─────────────────────│
    │                  ││────────────────────┬───┬───┬───────┬───────────┬───────┬───────────────────┬───────────┬───────┬───────────────────┬─────────────────────│
    │scan_address      ││ 0                  │1  │2  │3      │0          │1      │2                  │0          │1      │2                  │0                    │
    │                  ││────────────────────┴───┴───┴───────┴───────────┴───────┴───────────────────┴───────────┴───────┴───────────────────┴─────────────────────│
    │                  ││────────────────────────────────────────────────────────────────┬───┬───┬───┬───────────────────────────┬───┬───┬───┬─────────────────────│
    │blk_x             ││ 0                                                              │1  │0  │1  │0                          │1  │0  │1  │0                    │
    │                  ││────────────────────────────────────────────────────────────────┴───┴───┴───┴───────────────────────────┴───┴───┴───┴─────────────────────│
    │                  ││────────────────────────────────────────────┬───┬───────────────────┬───────┬───────┬───┬───────────────────┬───────┬─────────────────────│
    │blk_y             ││ 0                                          │1  │0                  │1      │0      │1  │0                  │1      │0                    │
    │                  ││────────────────────────────────────────────┴───┴───────────────────┴───────┴───────┴───┴───────────────────┴───────┴─────────────────────│
    │                  ││────────────────────────────────────────────────────────────────┬───┬───┬───┬───────────────────────────┬───┬───┬───┬─────────────────────│
    │x_pos             ││ 0                                                              │8  │0  │8  │0                          │8  │0  │8  │0                    │
    │                  ││────────────────────────────────────────────────────────────────┴───┴───┴───┴───────────────────────────┴───┴───┴───┴─────────────────────│
    │                  ││────────────────────────────────────────────┬───┬───┬───┬───┬───────┬───────┬───────┬───┬───┬───┬───────────┬───────┬─────────────────────│
    │y_pos             ││ 0                                          │8  │16 │0  │8  │0      │8      │16     │24 │32 │8  │16         │24     │32                   │
    │                  ││────────────────────────────────────────────┴───┴───┴───┴───┴───────┴───────┴───────┴───┴───┴───┴───────────┴───────┴─────────────────────│
    │                  ││────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │max_horz_sampling ││ 0      │2                                                                                                                                │
    │                  ││────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │max_vert_sampling ││ 0      │2                                                                                                                                │
    │                  ││────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │width_in_blocks   ││ 0  │2                                                                                                                                    │
    │                  ││────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │height_in_blocks  ││ 0  │4                                                                                                                                    │
    │                  ││────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────┬───────────────────────────────┬───────────────────┬───────────────────┬───────────────────┬─────────────────────────────────────────│
    │component_width   ││ 0  │2                              │1                  │2                  │1                  │2                                        │
    │                  ││────┴───────────────────────────────┴───────────────────┴───────────────────┴───────────────────┴─────────────────────────────────────────│
    │                  ││────┬───────────────────────────────────────────┬───────┬───────────────────────────────┬───────┬─────────────────────────────────────────│
    │component_height  ││ 0  │4                                          │2      │4                              │2      │4                                        │
    │                  ││────┴───────────────────────────────────────────┴───────┴───────────────────────────────┴───────┴─────────────────────────────────────────│
    │scan$ac           ││                                                    ┌───────────────────────────┐           ┌─────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────┘                           └───────────┘                                             │
    │                  ││────────────────────────────────────────┬───────────┬───────┬───────────────────┬───────────┬───────┬─────────────────────────────────────│
    │scan$component_ind││ 0                                      │1          │2      │0                  │1          │2      │0                                    │
    │                  ││────────────────────────────────────────┴───────────┴───────┴───────────────────┴───────────┴───────┴─────────────────────────────────────│
    │scan$dc           ││                                                    ┌───────────────────────────┐           ┌─────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────┘                           └───────────┘                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │scan$dc_pred      ││ 0                                                                                                                                        │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────┬───┬───┬───┬───────────────────────────┬───┬───┬───┬─────────────────────│
    │scan$x_pos        ││ 0                                                              │1  │0  │1  │0                          │1  │0  │1  │0                    │
    │                  ││────────────────────────────────────────────────────────────────┴───┴───┴───┴───────────────────────────┴───┴───┴───┴─────────────────────│
    │                  ││────────────────────────────────────────────┬───┬───┬───┬───┬───────┬───────┬───────┬───┬───┬───┬───────────┬───────┬─────────────────────│
    │scan$y_pos        ││ 0                                          │1  │2  │0  │1  │0      │1      │2      │3  │4  │1  │2          │3      │4                    │
    │                  ││────────────────────────────────────────────┴───┴───┴───┴───┴───────┴───────┴───────┴───┴───┴───┴───────────┴───────┴─────────────────────│
    │                  ││────────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$ac_coef_select││ 0                  │1                                                                                                                    │
    │                  ││────────────────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$dc_coef_select││ 0                  │1                                                                                                                    │
    │                  ││────────────────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────┬───┬───┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$identifier    ││ 00             │09 │02 │07                                                                                                               │
    │                  ││────────────────┴───┴───┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]
;;
