(* This is the interesting marker code. 
   
  Decoding the bits is relatively straight forward, but then they need to be 
  decoded into huffman codewords.
  
  I think many hardware decoders just use the pre-defined code tables, but I 
  am kinda interested in seeing how we might support the more general case.
*)

open Core
open Hardcaml
open Hardcaml_waveterm
open Hardcaml_jpeg
open Util
module Dht = Wrapped_marker_decoder (Markers.Dht.Fields) (Markers.Dht)

let test ?(verbose = false) ~start_cycle nth_marker =
  let bits = Test_vld.load_jpeg () in
  let dht_bits =
    find_nth_marker_exn
      ~n:nth_marker
      ~marker_code:Hardcaml_jpeg_model.Marker_code.dht
      bits
  in
  if verbose then print_s [%message (dht_bits : String.Hexdump.t)];
  let on_cycle (outputs : _ Dht.O.t) =
    if Bits.to_bool !(outputs.fields.value_write)
    then (
      let value = Bits.to_int !(outputs.fields.value) in
      let index = Bits.to_int !(outputs.fields.value_index) in
      let address = Bits.to_int !(outputs.fields.value_address) in
      print_s [%message (value : int) (index : int) (address : int)])
  in
  let waves = Dht.test ~waves:true ~on_cycle dht_bits in
  Option.iter
    waves
    ~f:(Waveform.print ~start_cycle ~wave_width:1 ~display_width:120 ~display_height:50)
;;

let%expect_test "1st marker" =
  test ~verbose:true ~start_cycle:16 0;
  [%expect
    {|
      (dht_bits
       ("00000000  00 1a 00 00 03 01 01 01  01 00 00 00 00 00 00 00  |................|"
        "00000010  00 00 00 00 01 02 03 04  05 06                    |..........|"))
      ((value 0) (index 1) (address 0))
      ((value 1) (index 1) (address 1))
      ((value 2) (index 1) (address 2))
      ((value 3) (index 2) (address 0))
      ((value 4) (index 3) (address 0))
      ((value 5) (index 4) (address 0))
      ((value 6) (index 5) (address 0))
      ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────┐
      │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
      │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
      │clear             ││                                                                                                  │
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────  │
      │start             ││                                                                                                  │
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────  │
      │done_             ││                                                                                            ┌───  │
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────┘     │
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────  │
      │hdr$destination_id││ 0                                                                                                │
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────  │
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────  │
      │hdr$length        ││ 001A                                                                                             │
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────  │
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────  │
      │hdr$table_class   ││ 0                                                                                                │
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────  │
      │                  ││────────────────────────┬───────────┬───────────────┬───────────────────────────────────────────  │
      │length            ││ 00                     │03         │01             │00                                           │
      │                  ││────────────────────────┴───────────┴───────────────┴───────────────────────────────────────────  │
      │                  ││────────────────────────────┬───┬───┬───┬───┬───┬───┬───────────────────────────────────────────  │
      │length_address    ││ 0                          │1  │2  │3  │4  │5  │6  │0                                            │
      │                  ││────────────────────────────┴───┴───┴───┴───┴───┴───┴───────────────────────────────────────────  │
      │length_write      ││────────────────────┐                                                                             │
      │                  ││                    └───────────────────────────────────────────────────────────────────────────  │
      │                  ││────────────────────────────┬───┬───┬───┬───┬───┬───┬───────────────────────────────────────────  │
      │value             ││ 00                         │01 │02 │03 │04 │05 │06 │00                                           │
      │                  ││────────────────────────────┴───┴───┴───┴───┴───┴───┴───────────────────────────────────────────  │
      │                  ││────────────────────────────┬───┬───┬───────────────────────────────────────────────────────────  │
      │value_address     ││ 00                         │01 │02 │00                                                           │
      │                  ││────────────────────────────┴───┴───┴───────────────────────────────────────────────────────────  │
      │                  ││────┬───┬───┬───┬───┬───┬───────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───  │
      │value_index       ││ B  │C  │D  │E  │F  │0  │1          │2  │3  │4  │5  │6  │7  │8  │9  │A  │B  │C  │D  │E  │F  │0    │
      │                  ││────┴───┴───┴───┴───┴───┴───────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───  │
      │value_write       ││                        ┌───────────────────────────┐                                             │
      │                  ││────────────────────────┘                           └───────────────────────────────────────────  │
      │                  ││────────────────────┬───────┬───┬───┬───┬───┬───┬───┬───────────────────────────────────────────  │
      │BITS              ││ 0000               │0100   │02.│03.│04.│05.│06.│00.│0000                                         │
      │                  ││────────────────────┴───────┴───┴───┴───┴───┴───┴───┴───────────────────────────────────────────  │
      │                  ││────────────────────┬───┬───────────────────────────┬───────────────────────────────────────────  │
      │READ_BITS         ││ 08                 │00 │08                         │00                                           │
      │                  ││────────────────────┴───┴───────────────────────────┴───────────────────────────────────────────  │
      │                  ││────────────────────────┬───────────┬───────────────┬───────────────────────────────────────────  │
      │dht$LENGTHS       ││ 00                     │03         │01             │00                                           │
      │                  ││────────────────────────┴───────────┴───────────────┴───────────────────────────────────────────  │
      │gnd               ││                                                                                                  │
      │                  ││────────────────────────────────────────────────────────────────────────────────────────────────  │
      │vdd               ││────────────────────────────────────────────────────────────────────────────────────────────────  │
      └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "2nd marker" =
  test ~verbose:true ~start_cycle:16 1;
  [%expect
    {|
    (dht_bits
     ("00000000  00 2d 10 00 02 02 01 04  01 04 02 01 04 03 01 01  |.-..............|"
      "00000010  00 00 00 00 01 02 11 21  03 12 31 41 51 04 13 22  |.......!..1AQ..\"|"
      "00000020  61 32 71 81 05 23 42 91  14 33 52 a1 c1           |a2q..#B..3R..|"))
    ((value 0) (index 1) (address 0))
    ((value 1) (index 1) (address 1))
    ((value 2) (index 2) (address 0))
    ((value 17) (index 2) (address 1))
    ((value 33) (index 3) (address 0))
    ((value 3) (index 4) (address 0))
    ((value 18) (index 4) (address 1))
    ((value 49) (index 4) (address 2))
    ((value 65) (index 4) (address 3))
    ((value 81) (index 5) (address 0))
    ((value 4) (index 6) (address 0))
    ((value 19) (index 6) (address 1))
    ((value 34) (index 6) (address 2))
    ((value 97) (index 6) (address 3))
    ((value 50) (index 7) (address 0))
    ((value 113) (index 7) (address 1))
    ((value 129) (index 8) (address 0))
    ((value 5) (index 9) (address 0))
    ((value 35) (index 9) (address 1))
    ((value 66) (index 9) (address 2))
    ((value 145) (index 9) (address 3))
    ((value 20) (index 10) (address 0))
    ((value 51) (index 10) (address 1))
    ((value 82) (index 10) (address 2))
    ((value 161) (index 11) (address 0))
    ((value 193) (index 12) (address 0))
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
    │clear             ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │start             ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │done_             ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │hdr$destination_id││ 1                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │hdr$length        ││ 002D                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │hdr$table_class   ││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────┬───────────────┬───┬───────────────┬───┬───────────────┬───────┬───┬─────│
    │length            ││ 00                     │02             │01 │04             │01 │04             │02     │01 │04   │
    │                  ││────────────────────────┴───────────────┴───┴───────────────┴───┴───────────────┴───────┴───┴─────│
    │                  ││────────┬───────────────────┬───┬───┬───────┬───┬───┬───────────┬───┬───┬───┬───┬───┬───────┬───┬─│
    │length_address    ││ 1      │0                  │1  │2  │1      │3  │2  │1          │4  │3  │2  │1  │2  │1      │5  │3│
    │                  ││────────┴───────────────────┴───┴───┴───────┴───┴───┴───────────┴───┴───┴───┴───┴───┴───────┴───┴─│
    │length_write      ││────────────────────┐                                                                             │
    │                  ││                    └─────────────────────────────────────────────────────────────────────────────│
    │                  ││────────┬───────────────────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─│
    │value             ││ 01     │00                 │01 │02 │11 │21 │03 │12 │31 │41 │51 │04 │13 │22 │61 │32 │71 │81 │05 │2│
    │                  ││────────┴───────────────────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─│
    │                  ││────────────────────────────┬───┬───┬───┬───────┬───┬───┬───┬───────┬───┬───┬───┬───┬───┬───────┬─│
    │value_address     ││ 00                         │01 │00 │01 │00     │01 │02 │03 │00     │01 │02 │03 │00 │01 │00     │0│
    │                  ││────────────────────────────┴───┴───┴───┴───────┴───┴───┴───┴───────┴───┴───┴───┴───┴───┴───────┴─│
    │                  ││────┬───┬───┬───┬───┬───┬───────┬───────┬───┬───────────────┬───┬───────────────┬───────┬───┬─────│
    │value_index       ││ B  │C  │D  │E  │F  │0  │1      │2      │3  │4              │5  │6              │7      │8  │9    │
    │                  ││────┴───┴───┴───┴───┴───┴───────┴───────┴───┴───────────────┴───┴───────────────┴───────┴───┴─────│
    │value_write       ││                        ┌─────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────┘                                                                         │
    │                  ││────┬───┬───────────┬───────┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬─│
    │BITS              ││ 01.│00.│0000       │0100   │02.│11.│21.│03.│12.│31.│41.│51.│04.│13.│22.│61.│32.│71.│81.│05.│23.│4│
    │                  ││────┴───┴───────────┴───────┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴─│
    │                  ││────────────────────┬───┬─────────────────────────────────────────────────────────────────────────│
    │READ_BITS         ││ 08                 │00 │08                                                                       │
    │                  ││────────────────────┴───┴─────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────┬───────────────┬───┬───────────────┬───┬───────────────┬───────┬───┬─────│
    │dht$LENGTHS       ││ 00                     │02             │01 │04             │01 │04             │02     │01 │04   │
    │                  ││────────────────────────┴───────────────┴───┴───────────────┴───┴───────────────┴───────┴───┴─────│
    │gnd               ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │vdd               ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]
;;
