open Core
open Hardcaml
open Hardcaml_waveterm
open Hardcaml_jpeg
open Hardcaml_jpeg_model
module Accl = Decoder_accelerator
module Sim = Cyclesim.With_interface (Accl.I) (Accl.O)

let display_rules =
  let module I = Display_rules.With_interface (Accl.I) in
  let module O = Display_rules.With_interface (Accl.O) in
  Display_rule.[ I.default (); O.default (); [ default ] ] |> List.concat
;;

let get_headers_and_bits jpeg =
  let bits = Util.load_jpeg_file jpeg in
  let headers = Model.Header.decode bits in
  let bits = Bitstream_reader.From_string.get_buffer bits in
  let soi = Util.find_next_marker_exn ~start_pos:0 ~marker_code:Marker_code.soi bits in
  let eoi =
    Util.find_next_marker_exn ~start_pos:(soi + 2) ~marker_code:Marker_code.eoi bits
  in
  headers, String.sub ~pos:(soi + 2) ~len:(eoi - (soi + 2)) bits
;;

let test ?(waves = false) jpeg =
  let headers, data = get_headers_and_bits jpeg in
  let sim =
    Sim.create
      ~config:Cyclesim.Config.trace_all
      (Accl.create
         (Scope.create ~flatten_design:true ~auto_label_hierarchical_ports:true ()))
  in
  let waves, sim =
    if waves
    then (
      let waves, sim = Waveform.create sim in
      Some waves, sim)
    else None, sim
  in
  let inputs = Cyclesim.inputs sim in
  let _outputs = Cyclesim.outputs sim in
  let outputs_before = Cyclesim.outputs ~clock_edge:Before sim in
  inputs.clocking.clear := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.clocking.clear := Bits.gnd;
  let huffman_tables = Model.Header.huffman_tables headers in
  Util.load_huffman_tables ~cycle:(fun () -> Cyclesim.cycle sim) inputs.dht huffman_tables;
  let quant_tables = Model.Header.quant_tables headers in
  Util.load_quant_tables ~cycle:(fun () -> Cyclesim.cycle sim) inputs.dqt quant_tables;
  inputs.start := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.start := Bits.gnd;
  inputs.jpeg_valid := Bits.vdd;
  let pos = ref 0 in
  let get_data () =
    let d0 =
      try Char.to_int data.[(!pos * 2) + 0] with
      | _ -> 0
    in
    let d1 =
      try Char.to_int data.[(!pos * 2) + 1] with
      | _ -> 0
    in
    Bits.of_int ~width:16 ((d0 lsl 8) lor d1)
  in
  inputs.jpeg := get_data ();
  Int.incr pos;
  let cycle () =
    Cyclesim.cycle sim;
    if Bits.to_bool !(outputs_before.jpeg_ready)
    then (
      inputs.jpeg := get_data ();
      Int.incr pos)
  in
  for _ = 0 to 2200 do
    cycle ()
  done;
  waves
;;

let%expect_test "" =
  let waves = test ~waves:true "Mouse480.jpg" in
  Option.iter
    waves
    ~f:
      (Waveform.print
         ~display_rules
         ~display_width:120
         ~display_height:75
         ~wave_width:(-30));
  [%expect
    {|
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────┐
    │clock             ││╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥╥│
    │                  ││╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨╨│
    │clear             ││╥                                                                                                 │
    │                  ││╨─────────────────────────────────────────────────────────────────────────────────                │
    │start             ││       ╥                                                                                          │
    │                  ││───────╨──────────────────────────────────────────────────────────────────────────                │
    │                  ││╥╥╥───────────────────────────────────────────────────────────────────────────────                │
    │hdr$table_class   ││║║║ 0                                                                                             │
    │                  ││╨╨╨───────────────────────────────────────────────────────────────────────────────                │
    │                  ││╥╥────────────────────────────────────────────────────────────────────────────────                │
    │hdr$destination_id││║║ 0                                                                                              │
    │                  ││╨╨────────────────────────────────────────────────────────────────────────────────                │
    │                  ││╥╥╥╥──────────────────────────────────────────────────────────────────────────────                │
    │code_length_minus1││║║║║ F                                                                                            │
    │                  ││╨╨╨╨──────────────────────────────────────────────────────────────────────────────                │
    │                  ││╥╥╥───────────────────────────────────────────────────────────────────────────────                │
    │num_codes_at_lengt││║║║ 00                                                                                            │
    │                  ││╨╨╨───────────────────────────────────────────────────────────────────────────────                │
    │                  ││╥╥╥╥──────────────────────────────────────────────────────────────────────────────                │
    │code              ││║║║║ FC00                                                                                         │
    │                  ││╨╨╨╨──────────────────────────────────────────────────────────────────────────────                │
    │                  ││╥╥╥───────────────────────────────────────────────────────────────────────────────                │
    │code_base_address ││║║║ 0007                                                                                          │
    │                  ││╨╨╨───────────────────────────────────────────────────────────────────────────────                │
    │code_write        ││╥╥╥╥                                                                                              │
    │                  ││╨╨╨╨──────────────────────────────────────────────────────────────────────────────                │
    │                  ││╥╥╥╥──────────────────────────────────────────────────────────────────────────────                │
    │data              ││║║║║ 06                                                                                           │
    │                  ││╨╨╨╨──────────────────────────────────────────────────────────────────────────────                │
    │                  ││╥╥╥╥──────────────────────────────────────────────────────────────────────────────                │
    │data_address      ││║║║║ 0006                                                                                         │
    │                  ││╨╨╨╨──────────────────────────────────────────────────────────────────────────────                │
    │data_write        ││╥╥╥╥                                                                                              │
    │                  ││╨╨╨╨──────────────────────────────────────────────────────────────────────────────                │
    │                  ││───╥─╥────────────────────────────────────────────────────────────────────────────                │
    │table_identifier  ││ 0 ║ ║ 0                                                                                          │
    │                  ││───╨─╨────────────────────────────────────────────────────────────────────────────                │
    │                  ││───╥─╥╥╥──────────────────────────────────────────────────────────────────────────                │
    │element           ││ 0.║ ║║║ 00F8                                                                                     │
    │                  ││───╨─╨╨╨──────────────────────────────────────────────────────────────────────────                │
    │                  ││───╥╥╥╥╥──────────────────────────────────────────────────────────────────────────                │
    │element_address   ││ 00║║║║║ 3F                                                                                       │
    │                  ││───╨╨╨╨╨──────────────────────────────────────────────────────────────────────────                │
    │element_write     ││   ╥───╥                                                                                          │
    │                  ││───╨   ╨──────────────────────────────────────────────────────────────────────────                │
    │luma_or_chroma    ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────                │
    │dc_pred_in        ││ 000                                                                                              │
    │                  ││──────────────────────────────────────────────────────────────────────────────────                │
    │                  ││───────╥──────────────────────────────────────────────────────────────────────────                │
    │jpeg              ││ 0000  ║ 0010                                                                                     │
    │                  ││───────╨──────────────────────────────────────────────────────────────────────────                │
    │jpeg_valid        ││       ╥──────────────────────────────────────────────────────────────────────────                │
    │                  ││───────╨                                                                                          │
    │                  ││──────────────────────────────────────────────────────────────────────────────────                │
    │pixel_read_address││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────                │
    │pixel_read_enable ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────                │
    │pixel             ││ 80                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────                │
    │dc_pred_out       ││ 000                                                                                              │
    │                  ││──────────────────────────────────────────────────────────────────────────────────                │
    │jpeg_ready        ││       ╥                                                                                          │
    │                  ││───────╨──────────────────────────────────────────────────────────────────────────                │
    │done_             ││───────╥                                  ┌───────────────────────────────────────                │
    │                  ││       ╨──────────────────────────────────┘                                                       │
    │bsread$STATE      ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────                │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]
;;
