open Core
open Hardcaml
open Hardcaml_waveterm
module Fsb = Hardcaml_jpeg.Filter_stuffed_bytes
module Sim = Cyclesim.With_interface (Fsb.I) (Fsb.O)

let test steps =
  let sim = Sim.create ~config:Cyclesim.Config.trace_all (Fsb.create (Scope.create ())) in
  let waves, sim = Waveform.create sim in
  let inputs = Cyclesim.inputs sim in
  inputs.clocking.clear := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.clocking.clear := Bits.gnd;
  let step valid data ready =
    inputs.i_valid := Bits.of_bool valid;
    inputs.i_data := Bits.of_int ~width:16 data;
    inputs.o_ready := Bits.of_bool ready;
    Cyclesim.cycle sim
  in
  List.iter steps ~f:(fun (valid, data, ready) -> step valid data ready);
  for _ = 0 to 3 do
    step false 0 false
  done;
  Waveform.print ~wave_width:2 ~display_width:110 ~display_height:46 waves
;;

let%expect_test "" =
  test
    [ true, 0x12, false
    ; true, 0x34, true
    ; false, 0, true
    ; false, 0x45, false
    ; false, 0x45, true
    ; true, 0x45, true
    ; false, 0x0, true
    ];
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐│
    │                  ││   └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └│
    │clear             ││──────┐                                                                                 │
    │                  ││      └─────────────────────────────────────────────────────────────────                │
    │                  ││──────┬─────┬─────┬─────┬─────────────────┬─────────────────────────────                │
    │i_data            ││ 0000 │0012 │0034 │0000 │0045             │0000                                         │
    │                  ││──────┴─────┴─────┴─────┴─────────────────┴─────────────────────────────                │
    │i_valid           ││      ┌───────────┐                 ┌─────┐                                             │
    │                  ││──────┘           └─────────────────┘     └─────────────────────────────                │
    │o_ready           ││            ┌───────────┐     ┌─────────────────┐                                       │
    │                  ││────────────┘           └─────┘                 └───────────────────────                │
    │i_ready           ││      ┌───────────┐                 ┌─────┐                                             │
    │                  ││──────┘           └─────────────────┘     └─────────────────────────────                │
    │                  ││────────────┬─────┬───────────────────────┬─────────────────────────────                │
    │o_data            ││ 0000       │0012 │0034                   │0045                                         │
    │                  ││────────────┴─────┴───────────────────────┴─────────────────────────────                │
    │o_valid           ││            ┌───────────┐                 ┌─────┐                                       │
    │                  ││────────────┘           └─────────────────┘     └───────────────────────                │
    │                  ││────────────────────────────────────────────────────────────────────────                │
    │data_1            ││ 00                                                                                     │
    │                  ││────────────────────────────────────────────────────────────────────────                │
    │                  ││──────┬─────┬─────┬─────┬─────────────────┬─────────────────────────────                │
    │data_2            ││ 00   │12   │34   │00   │45               │00                                           │
    │                  ││──────┴─────┴─────┴─────┴─────────────────┴─────────────────────────────                │
    │gnd               ││                                                                                        │
    │                  ││────────────────────────────────────────────────────────────────────────                │
    │have_buffered_byte││                                                                                        │
    │                  ││────────────────────────────────────────────────────────────────────────                │
    │is_00_1           ││────────────────────────────────────────────────────────────────────────                │
    │                  ││                                                                                        │
    │is_00_2           ││──────┐           ┌─────┐                 ┌─────────────────────────────                │
    │                  ││      └───────────┘     └─────────────────┘                                             │
    │is_ff_1           ││                                                                                        │
    │                  ││────────────────────────────────────────────────────────────────────────                │
    │last_byte_was_ff  ││                                                                                        │
    │                  ││────────────────────────────────────────────────────────────────────────                │
    │remove_first_byte ││────────────────────────────────────────────────────────────────────────                │
    │                  ││                                                                                        │
    │remove_second_byte││──────┐           ┌─────┐                 ┌─────────────────────────────                │
    │                  ││      └───────────┘     └─────────────────┘                                             │
    │vdd               ││────────────────────────────────────────────────────────────────────────                │
    │                  ││                                                                                        │
    │                  ││                                                                                        │
    │                  ││                                                                                        │
    └──────────────────┘└────────────────────────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "test byte stuffing removal" =
  test
    [ true, 0xaabb, true
    ; true, 0xff00, true
    ; true, 0xccdd, true
    ; true, 0xeeff, true
    ; false, 0x0, true
    ];
  [%expect
    {|
   ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────────────────────────┐
   │clock             ││┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐│
   │                  ││   └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └│
   │clear             ││──────┐                                                                                 │
   │                  ││      └─────────────────────────────────────────────────────                            │
   │                  ││──────┬─────┬─────┬─────┬─────┬─────────────────────────────                            │
   │i_data            ││ 0000 │AABB │FF00 │CCDD │EEFF │0000                                                     │
   │                  ││──────┴─────┴─────┴─────┴─────┴─────────────────────────────                            │
   │i_valid           ││      ┌───────────────────────┐                                                         │
   │                  ││──────┘                       └─────────────────────────────                            │
   │o_ready           ││      ┌─────────────────────────────┐                                                   │
   │                  ││──────┘                             └───────────────────────                            │
   │i_ready           ││      ┌───────────────────────┐                                                         │
   │                  ││──────┘                       └─────────────────────────────                            │
   │                  ││────────────┬───────────┬─────┬─────────────────────────────                            │
   │o_data            ││ 0000       │AABB       │FFCC │DDEE                                                     │
   │                  ││────────────┴───────────┴─────┴─────────────────────────────                            │
   │o_valid           ││            ┌─────┐     ┌───────────┐                                                   │
   │                  ││────────────┘     └─────┘           └───────────────────────                            │
   │                  ││──────┬─────┬─────┬─────┬─────┬─────────────────────────────                            │
   │data_1            ││ 00   │AA   │FF   │CC   │EE   │00                                                       │
   │                  ││──────┴─────┴─────┴─────┴─────┴─────────────────────────────                            │
   │                  ││──────┬─────┬─────┬─────┬─────┬─────────────────────────────                            │
   │data_2            ││ 00   │BB   │00   │DD   │FF   │00                                                       │
   │                  ││──────┴─────┴─────┴─────┴─────┴─────────────────────────────                            │
   │gnd               ││                                                                                        │
   │                  ││────────────────────────────────────────────────────────────                            │
   │have_buffered_byte││                  ┌─────────────────────────────────────────                            │
   │                  ││──────────────────┘                                                                     │
   │is_00_1           ││──────┐                       ┌─────────────────────────────                            │
   │                  ││      └───────────────────────┘                                                         │
   │is_00_2           ││──────┐     ┌─────┐           ┌─────────────────────────────                            │
   │                  ││      └─────┘     └───────────┘                                                         │
   │is_ff_1           ││            ┌─────┐                                                                     │
   │                  ││────────────┘     └─────────────────────────────────────────                            │
   │last_byte_was_ff  ││                  ┌─────┐     ┌─────────────────────────────                            │
   │                  ││──────────────────┘     └─────┘                                                         │
   │remove_first_byte ││──────┐                       ┌─────────────────────────────                            │
   │                  ││      └───────────────────────┘                                                         │
   │remove_second_byte││──────┐     ┌─────┐           ┌─────────────────────────────                            │
   │                  ││      └─────┘     └───────────┘                                                         │
   │vdd               ││────────────────────────────────────────────────────────────                            │
   │                  ││                                                                                        │
   │                  ││                                                                                        │
   │                  ││                                                                                        │
   └──────────────────┘└────────────────────────────────────────────────────────────────────────────────────────┘ |}]
;;

let%expect_test "byte stuffing crossing words" =
  test
    [ true, 0xaabb, true
    ; true, 0xccff, true
    ; true, 0x00dd, true
    ; true, 0xeeff, true
    ; false, 0x0, true
    ];
  [%expect
    {|
    ┌Signals───────────┐┌Waves───────────────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐│
    │                  ││   └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └│
    │clear             ││──────┐                                                                                 │
    │                  ││      └─────────────────────────────────────────────────────                            │
    │                  ││──────┬─────┬─────┬─────┬─────┬─────────────────────────────                            │
    │i_data            ││ 0000 │AABB │CCFF │00DD │EEFF │0000                                                     │
    │                  ││──────┴─────┴─────┴─────┴─────┴─────────────────────────────                            │
    │i_valid           ││      ┌───────────────────────┐                                                         │
    │                  ││──────┘                       └─────────────────────────────                            │
    │o_ready           ││      ┌─────────────────────────────┐                                                   │
    │                  ││──────┘                             └───────────────────────                            │
    │i_ready           ││      ┌───────────────────────┐                                                         │
    │                  ││──────┘                       └─────────────────────────────                            │
    │                  ││────────────┬─────┬───────────┬─────────────────────────────                            │
    │o_data            ││ 0000       │AABB │CCFF       │DDEE                                                     │
    │                  ││────────────┴─────┴───────────┴─────────────────────────────                            │
    │o_valid           ││            ┌───────────┐     ┌─────┐                                                   │
    │                  ││────────────┘           └─────┘     └───────────────────────                            │
    │                  ││──────┬─────┬─────┬─────┬─────┬─────────────────────────────                            │
    │data_1            ││ 00   │AA   │CC   │00   │EE   │00                                                       │
    │                  ││──────┴─────┴─────┴─────┴─────┴─────────────────────────────                            │
    │                  ││──────┬─────┬─────┬─────┬─────┬─────────────────────────────                            │
    │data_2            ││ 00   │BB   │FF   │DD   │FF   │00                                                       │
    │                  ││──────┴─────┴─────┴─────┴─────┴─────────────────────────────                            │
    │gnd               ││                                                                                        │
    │                  ││────────────────────────────────────────────────────────────                            │
    │have_buffered_byte││                        ┌───────────────────────────────────                            │
    │                  ││────────────────────────┘                                                               │
    │is_00_1           ││──────┐           ┌─────┐     ┌─────────────────────────────                            │
    │                  ││      └───────────┘     └─────┘                                                         │
    │is_00_2           ││──────┐                       ┌─────────────────────────────                            │
    │                  ││      └───────────────────────┘                                                         │
    │is_ff_1           ││                                                                                        │
    │                  ││────────────────────────────────────────────────────────────                            │
    │last_byte_was_ff  ││                  ┌─────┐     ┌─────────────────────────────                            │
    │                  ││──────────────────┘     └─────┘                                                         │
    │remove_first_byte ││──────┐           ┌─────┐     ┌─────────────────────────────                            │
    │                  ││      └───────────┘     └─────┘                                                         │
    │remove_second_byte││──────┐                       ┌─────────────────────────────                            │
    │                  ││      └───────────────────────┘                                                         │
    │vdd               ││────────────────────────────────────────────────────────────                            │
    │                  ││                                                                                        │
    │                  ││                                                                                        │
    │                  ││                                                                                        │
    └──────────────────┘└────────────────────────────────────────────────────────────────────────────────────────┘ |}]
;;
