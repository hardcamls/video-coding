open! Core
open Hardcaml
open Hardcaml_jpeg
open Hardcaml_waveterm
module Decode_headers = Hardcaml_jpeg.Decode_headers.Core
module Markers = Decode_headers.All_markers

module I = struct
  type 'a t =
    { clocking : 'a Clocking.t
    ; start : 'a
    }
  [@@deriving sexp_of, hardcaml]
end

module O = struct
  type 'a t =
    { markers : 'a Markers.t
    ; done_ : 'a
    }
  [@@deriving sexp_of, hardcaml]
end

open Signal

let create ~bits scope (i : _ I.t) =
  let read = wire 1 in
  let reader =
    Util.Super_simple_bitstream_reader.(
      create
        ~bits
        scope
        { I.clocking = i.clocking; read_bits = mux2 read (of_int ~width:5 8) (zero 5) })
  in
  let decoder =
    Decode_headers.(
      hierarchical
        scope
        { I.clocking = i.clocking
        ; start = i.start
        ; bits = reader.bits.:[15, 8]
        ; bits_valid = vdd
        })
  in
  read <== decoder.read_bits;
  { O.markers = decoder.markers; done_ = decoder.done_ }
;;

module Sim = Cyclesim.With_interface (I) (O)

let test ?(waves = true) jpeg =
  let jpeg = Util.load_jpeg_file jpeg in
  let bits = Hardcaml_jpeg_model.Bitstream_reader.From_string.get_buffer jpeg in
  print_s [%message (String.subo ~len:200 bits : String.Hexdump.t)];
  let sim =
    Sim.create
      ~config:Cyclesim.Config.trace_all
      (create
         ~bits
         (Scope.create ~auto_label_hierarchical_ports:true ~flatten_design:true ()))
  in
  let waves, sim =
    if waves
    then (
      let waves, sim = Waveform.create sim in
      Some waves, sim)
    else None, sim
  in
  let inputs = Cyclesim.inputs sim in
  let outputs = Cyclesim.outputs sim in
  inputs.clocking.clear := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.clocking.clear := Bits.gnd;
  inputs.start := Bits.vdd;
  Cyclesim.cycle sim;
  inputs.start := Bits.gnd;
  while not (Bits.to_bool !(outputs.done_)) do
    Cyclesim.cycle sim
  done;
  Cyclesim.cycle sim;
  Cyclesim.cycle sim;
  let markers = Markers.map outputs.markers ~f:(fun d -> Bits.to_int !d) in
  print_s [%message (markers : int Markers.t)];
  waves
;;

let%expect_test "debug vld" =
  Caller_id.set_mode Full_trace;
  let waves = test "Mouse480.jpg" in
  Option.iter
    waves
    ~f:
      (Waveform.print
         ~display_width:120
         ~display_height:150
         ~wave_width:2
         ~start_cycle:20);
  [%expect
    {|
    ("String.subo ~len:200 bits"
     ("00000000  ff d8 ff e0 00 10 4a 46  49 46 00 01 01 01 00 48  |......JFIF.....H|"
      "00000010  00 48 00 00 ff db 00 43  00 28 1c 1e 23 1e 19 28  |.H.....C.(..#..(|"
      "00000020  23 21 23 2d 2b 28 30 3c  64 41 3c 37 37 3c 7b 58  |#!#-+(0<dA<77<{X|"
      "00000030  5d 49 64 91 80 99 96 8f  80 8c 8a a0 b4 e6 c3 a0  |]Id.............|"
      "00000040  aa da ad 8a 8c c8 ff cb  da ee f5 ff ff ff 9b c1  |................|"
      "00000050  ff ff ff fa ff e6 fd ff  f8 ff db 00 43 01 2b 2d  |............C.+-|"
      "00000060  2d 3c 35 3c 76 41 41 76  f8 a5 8c a5 f8 f8 f8 f8  |-<5<vAAv........|"
      "00000070  f8 f8 f8 f8 f8 f8 f8 f8  f8 f8 f8 f8 f8 f8 f8 f8  |................|"
      "00000080  f8 f8 f8 f8 f8 f8 f8 f8  f8 f8 f8 f8 f8 f8 f8 f8  |................|"
      "00000090  f8 f8 f8 f8 f8 f8 f8 f8  f8 f8 f8 f8 f8 f8 ff c0  |................|"
      "000000a0  00 11 08 01 40 01 e0 03  01 22 00 02 11 01 03 11  |....@....\"......|"
      "000000b0  01 ff c4 00 1a 00 00 03  01 01 01 01 00 00 00 00  |................|"
      "000000c0  00 00 00 00 00 00 00 01                           |........|"))
    (markers
     ((sof
       ((frame_header
         ((length 17) (sample_precision 8) (height 320) (width 480)
          (number_of_components 3)))
        (component
         ((identifier 3) (vertical_sampling_factor 1)
          (horizontal_sampling_factor 1) (quantization_table_identifier 1)))
        (component_address 0) (component_write 0)))
      (sos
       ((header ((length 12) (number_of_image_components 3)))
        (scan_selector ((selector 3) (dc_coef_selector 1) (ac_coef_selector 1)))
        (write_scan_selector 0)
        (footer
         ((start_of_predictor_selection 0) (end_of_predictor_selection 63)
          (successive_approximation_bit_high 0)
          (successive_approximation_bit_low 0)))))
      (dqt
       ((fields ((length 67) (element_precision 0) (table_identifier 1)))
        (element 245) (element_address 0) (element_write 0)))
      (dht
       ((header ((length 22) (table_class 1) (destination_identifier 1)))
        (code
         ((code_length_minus1 0) (num_codes_at_length 245) (code 49152)
          (code_base_address 3) (code_write 0)))
        (code_data ((data 245) (data_address 3) (data_write 0)))))))
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌──┐  ┌─│
    │                  ││   └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘  └──┘ │
    │clear             ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │start             ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$code          ││ 0000                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$code_base_addr││ 0000                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$code_length_mi││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$code_write    ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────┬─────┬─────┬───────────┬─────┬─────┬───────────┬─────┬─────┬─────┬─────┬─────┬─────┬─│
    │dht$data          ││ 00         │FF   │DB   │00         │43   │00   │28         │1C   │1E   │23   │1E   │19   │28   │2│
    │                  ││────────────┴─────┴─────┴───────────┴─────┴─────┴───────────┴─────┴─────┴─────┴─────┴─────┴─────┴─│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$data_address  ││ 0000                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$data_write    ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$hdr$destinatio││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$hdr$length    ││ 0000                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │dht$hdr$table_clas││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────┬─────┬─────┬───────────┬─────┬─────┬───────────┬─────┬─────┬─────┬─────┬─────┬─────┬─│
    │dht$num_codes_at_l││ 00         │FF   │DB   │00         │43   │00   │28         │1C   │1E   │23   │1E   │19   │28   │2│
    │                  ││────────────┴─────┴─────┴───────────┴─────┴─────┴───────────┴─────┴─────┴─────┴─────┴─────┴─────┴─│
    │done_             ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────┬─────┬─────┬───────────┬─────┬─────┬───────────┬─────┬─────┬─────┬─────┬─────┬─────┬─│
    │dqt$element       ││ 0000       │00FF │00DB │0000       │0043 │0000 │0028       │001C │001E │0023 │001E │0019 │0028 │0│
    │                  ││────────────┴─────┴─────┴───────────┴─────┴─────┴───────────┴─────┴─────┴─────┴─────┴─────┴─────┴─│
    │                  ││────────────────────────────────────────────────────────────┬─────┬─────┬─────┬─────┬─────┬─────┬─│
    │dqt$element_addres││ 00                                                         │01   │02   │03   │04   │05   │06   │0│
    │                  ││────────────────────────────────────────────────────────────┴─────┴─────┴─────┴─────┴─────┴─────┴─│
    │                  ││──────────────────────────────────────────┬─────┬─────────────────────────────────────────────────│
    │dqt$element_precis││ 0                                        │4    │0                                                │
    │                  ││──────────────────────────────────────────┴─────┴─────────────────────────────────────────────────│
    │dqt$element_write ││                                                      ┌───────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────┘                                           │
    │                  ││────────────────────────────────────────────────┬─────────────────────────────────────────────────│
    │dqt$length        ││ 0000                                           │0043                                             │
    │                  ││────────────────────────────────────────────────┴─────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────┬─────┬─────────────────────────────────────────────────│
    │dqt$table_identifi││ 0                                        │3    │0                                                │
    │                  ││──────────────────────────────────────────┴─────┴─────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$component_addr││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$component_writ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$height        ││ 0000                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$horizontal_sam││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$identifier    ││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$length        ││ 0000                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$number_of_comp││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$quantization_t││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$sample_precisi││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$vertical_sampl││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sof$width         ││ 0000                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$ac_coef_select││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$dc_coef_select││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$end_of_predict││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$length        ││ 0000                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$number_of_imag││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$selector      ││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$start_of_predi││ 00                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$successive_app││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$successive_app││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │sos$write_scan_sel││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │gnd               ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │vdd               ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                                                  │
    │                  ││──────┬─────┬───────────┬─────────────────────────────────────────────────────────────────────────│
    │vld$SKIP_COUNT    ││ 000F │0010 │0011       │0000                                                                     │
    │                  ││──────┴─────┴───────────┴─────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │vld$SKIP_LENGTH   ││ 0010                                                                                             │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────┬─────┬─────┬─────────────────────────────────────────────────────────────────────────│
    │vld$STATE         ││ 8          │1    │2    │5                                                                        │
    │                  ││────────────┴─────┴─────┴─────────────────────────────────────────────────────────────────────────│
    │                  ││────────────┬─────┬─────┬───────────┬─────┬─────┬───────────┬─────┬─────┬─────┬─────┬─────┬─────┬─│
    │vld$dht$dhthdr$i$b││ 00         │FF   │DB   │00         │43   │00   │28         │1C   │1E   │23   │1E   │19   │28   │2│
    │                  ││────────────┴─────┴─────┴───────────┴─────┴─────┴───────────┴─────┴─────┴─────┴─────┴─────┴─────┴─│
    │vld$dht$dhthdr$i$b││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                                                  │
    │vld$dht$dhthdr$i$c││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │vld$dht$dhthdr$i$c││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │vld$dht$dhthdr$i$s││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │vld$dht$dhthdr$o$d││ 0                                                                                                │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │vld$dht$dhthdr$o$d││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────│
    │vld$dht$dhthdr$o$l││ 0000                                                                                             │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────┘ |}]
;;
