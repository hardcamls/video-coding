open! Base

let luma =
  [| 16
   ; 11
   ; 10
   ; 16
   ; 24
   ; 40
   ; 51
   ; 61
   ; 12
   ; 12
   ; 14
   ; 19
   ; 26
   ; 58
   ; 60
   ; 55
   ; 14
   ; 13
   ; 16
   ; 24
   ; 40
   ; 57
   ; 69
   ; 56
   ; 14
   ; 17
   ; 22
   ; 29
   ; 51
   ; 87
   ; 80
   ; 62
   ; 18
   ; 22
   ; 37
   ; 56
   ; 68
   ; 109
   ; 103
   ; 77
   ; 24
   ; 35
   ; 55
   ; 64
   ; 81
   ; 104
   ; 113
   ; 92
   ; 49
   ; 64
   ; 78
   ; 87
   ; 103
   ; 121
   ; 120
   ; 101
   ; 72
   ; 92
   ; 95
   ; 98
   ; 112
   ; 100
   ; 103
   ; 99
  |]
;;

let chroma =
  [| 17
   ; 18
   ; 24
   ; 47
   ; 99
   ; 99
   ; 99
   ; 99
   ; 18
   ; 21
   ; 26
   ; 66
   ; 99
   ; 99
   ; 99
   ; 99
   ; 24
   ; 26
   ; 56
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 47
   ; 66
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
   ; 99
  |]
;;

let clip x min max = if x < min then min else if x > max then max else x

let scale table q =
  let q = clip q 1 100 in
  let s = if q < 50 then 5000 / q else 200 - (2 * q) in
  Array.map table ~f:(fun d ->
      let d = ((d * s) + 50) / 100 in
      clip d 1 255)
;;
